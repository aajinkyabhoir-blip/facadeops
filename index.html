<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FacadeOps ‚Äì Project Control System</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap');
:root{--bg:#0d0f14;--surface:#151820;--surface2:#1c2030;--border:#252a3a;--accent:#f0a500;--accent2:#3b82f6;--accent3:#10b981;--danger:#ef4444;--warn:#f59e0b;--text:#e8eaf0;--muted:#6b7280;--wa:#25D366}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;min-height:100vh}
.app{display:flex;height:100vh;overflow:hidden}
.sidebar{width:225px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column}
.logo{padding:16px 16px 10px;border-bottom:1px solid var(--border)}
.logo h1{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;color:var(--accent);line-height:1}
.logo span{font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
#syncBar{padding:5px 16px;font-size:10px;display:flex;align-items:center;gap:5px;border-bottom:1px solid var(--border);min-height:26px}
#syncBar.synced{color:var(--accent3)}#syncBar.syncing{color:var(--warn)}#syncBar.error{color:var(--danger)}#syncBar.offline{color:var(--muted)}
.nav-section{padding:10px 0}
.nav-label{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);padding:0 16px 5px}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 16px;cursor:pointer;color:var(--muted);font-size:13px;font-weight:500;transition:all .15s;border-left:3px solid transparent}
.nav-item:hover{color:var(--text);background:var(--surface2)}
.nav-item.active{color:var(--accent);background:rgba(240,165,0,.08);border-left-color:var(--accent)}
.nav-item .icon{font-size:14px;width:18px;text-align:center}
.sidebar-project{padding:6px 16px}
.project-chip{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:7px 10px;cursor:pointer;margin-bottom:5px;transition:border-color .15s}
.project-chip:hover,.project-chip.active{border-color:var(--accent)}
.project-chip .pname{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.project-chip .pstage{font-size:9px;color:var(--muted)}
.progress-mini{height:2px;background:var(--border);border-radius:2px;margin-top:4px}
.progress-mini-fill{height:100%;border-radius:2px;background:var(--accent3)}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.page-title{font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:2px}
.topbar-right{display:flex;gap:8px;align-items:center}
.topbar-actions{display:flex;gap:8px;align-items:center}
.btn{padding:8px 16px;border-radius:6px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;transition:all .15s;display:inline-flex;align-items:center;gap:5px}
.btn-primary{background:var(--accent);color:#000}.btn-primary:hover{background:#ffc333}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger{background:var(--danger);color:#fff}.btn-success{background:var(--accent3);color:#fff}
.btn-wa{background:var(--wa);color:#fff}.btn-blue{background:var(--accent2);color:#fff}
.btn-sm{padding:5px 12px;font-size:12px}
.content{padding:24px;flex:1}
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:14px}
.card-title{font-size:11px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:10px}
.stats-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:16px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px}
.stat-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:3px}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:1px;color:var(--accent)}
.tbl{width:100%;border-collapse:collapse}
.tbl th{text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);padding:7px 10px;border-bottom:1px solid var(--border);font-weight:500}
.tbl td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}.tbl tr:hover td{background:var(--surface2)}
.badge{display:inline-block;padding:3px 9px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.badge-green{background:rgba(16,185,129,.15);color:var(--accent3)}.badge-yellow{background:rgba(245,158,11,.15);color:var(--warn)}
.badge-blue{background:rgba(59,130,246,.15);color:var(--accent2)}.badge-red{background:rgba(239,68,68,.15);color:var(--danger)}
.badge-gray{background:rgba(107,114,128,.15);color:var(--muted)}.badge-orange{background:rgba(249,115,22,.15);color:#f97316}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.form-full{grid-column:1/-1}
.field{display:flex;flex-direction:column;gap:3px}
.field label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:600}
.field input,.field select,.field textarea{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:9px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;transition:border-color .15s}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:var(--accent)}
.field textarea{resize:vertical;min-height:55px}
select option{background:var(--surface2)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:660px;max-width:96vw;max-height:92vh;overflow-y:auto}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px}
.modal-body{padding:20px}.modal-footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.close-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:2px 5px}.close-btn:hover{color:var(--text)}
.stage-timeline{display:flex;overflow-x:auto;margin-bottom:16px;padding-bottom:4px}
.stage-step{flex:1;min-width:75px;text-align:center;position:relative}
.stage-step::before{content:'';position:absolute;top:14px;left:50%;right:-50%;height:2px;background:var(--border);z-index:0}
.stage-step:last-child::before{display:none}
.step-circle{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;margin:0 auto 5px;font-size:10px;font-weight:700;position:relative;z-index:1;transition:all .2s}
.step-circle.done{background:var(--accent3);border-color:var(--accent3);color:#fff}
.step-circle.active{background:var(--accent);border-color:var(--accent);color:#000}
.step-label{font-size:8px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted)}
.step-label.active{color:var(--accent)}
.progress-bar{height:7px;background:var(--surface2);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px;transition:width .3s}
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:16px;flex-wrap:nowrap;overflow-x:auto}
.tab{padding:10px 18px;cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s;white-space:nowrap}
.tab:hover{color:var(--text)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.task-row{display:flex;align-items:center;gap:8px;padding:9px 10px;border-bottom:1px solid var(--border)}
.task-row:last-child{border-bottom:none}
.task-check{width:17px;height:17px;border-radius:4px;border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.task-check.done{background:var(--accent3);border-color:var(--accent3);color:#fff;font-size:10px}
.task-text{flex:1;font-size:12px}.task-text.done{text-decoration:line-through;color:var(--muted)}
.alert{padding:9px 12px;border-radius:7px;margin-bottom:8px;font-size:12px}
.alert-warn{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);color:var(--warn)}
.alert-danger{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:var(--danger)}
.alert-info{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);color:var(--accent2)}
.alert-success{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:var(--accent3)}
.view{display:none}.view.active{display:block}
.empty{text-align:center;padding:40px;color:var(--muted)}.empty-icon{font-size:40px;margin-bottom:10px}
.chip{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:11px;cursor:pointer;transition:all .15s}
.chip.active,.chip:hover{background:rgba(240,165,0,.15);border-color:var(--accent);color:var(--accent)}
.auth-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:36px;display:flex;flex-direction:column;align-items:center;gap:16px;max-width:420px;width:90%;text-align:center}
.auth-card h2{font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:4px;color:var(--accent)}
.auth-card p{color:var(--muted);font-size:13px;line-height:1.6}
.btn-google{background:#fff;color:#333;border:1px solid #ddd;font-size:13px;padding:11px 22px}
.btn-google:hover{background:#f5f5f5}
.rev-badge{background:rgba(249,115,22,.15);color:#f97316;border:1px solid rgba(249,115,22,.3);padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;font-family:'DM Mono',monospace}
.wa-preview{background:rgba(37,211,102,.07);border:1px solid rgba(37,211,102,.3);border-radius:8px;padding:12px;margin-top:10px}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.attached-file{display:inline-flex;align-items:center;gap:5px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:3px 8px;font-size:11px;margin:2px;text-decoration:none;color:var(--text)}
.attached-file:hover{border-color:var(--accent);color:var(--accent)}
@media(max-width:768px){
  .app{flex-direction:column;height:auto;min-height:100vh}
  .sidebar{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--border)}
  .logo{display:flex;justify-content:space-between;align-items:center}
  #sidebar-toggle{display:flex!important;background:none;border:none;color:var(--accent);font-size:22px;cursor:pointer}
  #sidebar-nav{display:none;flex-direction:column}
  #sidebar-nav.open{display:flex}
  .sidebar-project{display:none}
  .main{width:100%}
  .topbar{padding:10px 16px;flex-wrap:wrap;gap:8px}
  .page-title{font-size:22px}
  .content{padding:14px}
  .stats-row{grid-template-columns:repeat(2,1fr)}
  .form-grid,.form-grid-3{grid-template-columns:1fr}
  .form-full{grid-column:1}
  .modal{width:98vw;max-height:95vh}
  .tbl{display:block;overflow-x:auto}
}
#sidebar-toggle{display:none}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="auth-screen" id="authScreen">
  <div class="auth-card">
    <div style="font-size:50px">üèóÔ∏è</div>
    <h2>FacadeOps</h2>
    <p>Complete Facade Project Management System.<br>Sign in with Google to sync data and files across all your devices ‚Äî free.</p>
    <button class="btn btn-google" id="googleSignInBtn" onclick="handleGoogleSignIn()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:16px;height:16px;vertical-align:middle;margin-right:6px" alt="">Sign in with Google
    </button>
    <div id="authStatus" style="font-size:11px;color:var(--warn);min-height:16px;text-align:center;max-width:310px;line-height:1.5"></div>
    <div style="font-size:10px;color:var(--muted);text-align:center;line-height:1.8">
      ‚úÖ Data syncs to Google Drive &nbsp;|&nbsp; ‚úÖ Any device, any browser<br>
      ‚úÖ Files in "FacadeOps Files" folder &nbsp;|&nbsp; ‚úÖ 15 GB free
    </div>
    <div style="border-top:1px solid var(--border);padding-top:12px;width:100%;text-align:center">
      <button class="btn btn-outline btn-sm" onclick="startDemoMode()" style="font-size:11px">Continue without Google (local only)</button>
      <div style="font-size:10px;color:var(--muted);margin-top:6px">Local mode: data saved only in this browser, not synced</div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app" id="mainApp" style="display:none">

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo">
    <div><h1>FacadeOps</h1><span>Project Control</span></div>
    <button id="sidebar-toggle" onclick="toggleSidebar()">&#9776;</button>
  </div>
  <div id="syncBar" class="offline">Not connected</div>
  <div id="sidebar-nav">
    <div class="nav-section">
      <div class="nav-label">Main Menu</div>
      <div class="nav-item active" onclick="navigate('dashboard')"><span class="icon">üè†</span> Dashboard</div>
      <div class="nav-item" onclick="navigate('projects')"><span class="icon">üèóÔ∏è</span> Projects</div>
      <div class="nav-item" onclick="navigate('tasks')"><span class="icon">‚úÖ</span> Tasks</div>
      <div class="nav-item" onclick="navigate('issues')"><span class="icon">‚ö†Ô∏è</span> Issues</div>
      <div class="nav-item" onclick="navigate('materials')"><span class="icon">üì¶</span> Materials</div>
      <div class="nav-item" onclick="navigate('tools')"><span class="icon">üîß</span> Tools</div>
      <div class="nav-item" onclick="navigate('labor')"><span class="icon">üë∑</span> Labor</div>
      <div class="nav-item" onclick="navigate('finance')"><span class="icon">üí∞</span> Finance</div>
      <div class="nav-item" onclick="navigate('documents')"><span class="icon">üìÑ</span> Documents</div>
      <div class="nav-item" onclick="navigate('reports')"><span class="icon">üìä</span> Reports</div>
      <div class="nav-item" onclick="navigate('files')"><span class="icon">üìÅ</span> Files</div>
      <div class="nav-item" onclick="navigate('team')"><span class="icon">üë•</span> Team &amp; WhatsApp</div>
    </div>
    <div class="nav-section" style="border-top:1px solid var(--border)">
      <div class="nav-label">Active Projects</div>
      <div class="sidebar-project" id="sidebarProjects"></div>
      <div style="padding:0 16px 12px"><button class="btn btn-primary btn-sm" style="width:100%" onclick="openNewProjectModal()">+ New Project</button></div>
    </div>
    <div style="padding:10px 16px;border-top:1px solid var(--border);margin-top:auto">
      <div style="font-size:11px;color:var(--muted)" id="userInfo"></div>
      <button class="btn btn-outline btn-sm" style="margin-top:6px;width:100%" onclick="handleSignOut()">Sign Out</button>
    </div>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="main">
  <div class="topbar">
    <div class="page-title" id="pageTitle">DASHBOARD</div>
    <div class="topbar-right">
      <div class="topbar-actions" id="topbarActions"></div>
      <button class="btn btn-outline btn-sm" onclick="syncNow()">‚ü≥ Sync</button>
    </div>
  </div>
  <div class="content">

    <!-- DASHBOARD -->
    <div class="view active" id="view-dashboard">
      <div class="stats-row" id="dashStats"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div>
          <div class="card"><div class="card-title">Alerts &amp; Reminders</div><div id="dashAlerts"></div></div>
          <div class="card"><div class="card-title">Recent Activity</div><div id="dashActivity"></div></div>
        </div>
        <div class="card">
          <div class="card-title">All Projects</div>
          <div style="overflow-x:auto"><table class="tbl">
            <thead><tr><th>Project</th><th>Client</th><th>Stage</th><th>Progress</th><th>Deadline</th><th>Status</th></tr></thead>
            <tbody id="dashProjectRows"></tbody>
          </table></div>
        </div>
      </div>
    </div>

    <!-- PROJECTS LIST -->
    <div class="view" id="view-projects">
      <div id="projectListView">
        <div class="card">
          <div style="overflow-x:auto"><table class="tbl">
            <thead><tr><th>Project</th><th>Client</th><th>Value</th><th>Stage</th><th>Progress</th><th>Actions</th></tr></thead>
            <tbody id="projectRows"></tbody>
          </table></div>
        </div>
      </div>
      <div id="projectDetailView" style="display:none">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
          <button class="btn btn-outline btn-sm" onclick="showProjectList()">‚Üê All Projects</button>
          <span id="detailProjectName" style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px"></span>
          <button class="btn btn-blue btn-sm" onclick="editProject(currentProject)">Edit Project</button>
          <button class="btn btn-outline btn-sm" onclick="openVariationModal(currentProject)">+ Variation Order</button>
          <button class="btn btn-danger btn-sm" onclick="deleteProject(currentProject)">Delete</button>
        </div>
        <div class="stage-timeline" id="stageTimeline"></div>
        <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap" id="stageButtons"></div>
        <div class="tabs" id="projectTabs">
          <div class="tab active" onclick="switchTab(this,'ptab-overview')">Overview</div>
          <div class="tab" onclick="switchTab(this,'ptab-tasks')">Tasks</div>
          <div class="tab" onclick="switchTab(this,'ptab-revisions')">Revisions</div>
          <div class="tab" onclick="switchTab(this,'ptab-materials')">Materials</div>
          <div class="tab" onclick="switchTab(this,'ptab-delivery')">Delivery &amp; Certs</div>
          <div class="tab" onclick="switchTab(this,'ptab-mir')">MIR / WIR</div>
          <div class="tab" onclick="switchTab(this,'ptab-issues')">Issues</div>
          <div class="tab" onclick="switchTab(this,'ptab-tools')">Tools</div>
          <div class="tab" onclick="switchTab(this,'ptab-labor')">Labor</div>
          <div class="tab" onclick="switchTab(this,'ptab-finance')">Finance</div>
          <div class="tab" onclick="switchTab(this,'ptab-docs')">Documents</div>
          <div class="tab" onclick="switchTab(this,'ptab-log')">Daily Log</div>
        </div>
        <div class="project-tab" id="ptab-overview" style="display:block"></div>
        <div class="project-tab" id="ptab-tasks" style="display:none"></div>
        <div class="project-tab" id="ptab-revisions" style="display:none"></div>
        <div class="project-tab" id="ptab-materials" style="display:none"></div>
        <div class="project-tab" id="ptab-delivery" style="display:none"></div>
        <div class="project-tab" id="ptab-mir" style="display:none"></div>
        <div class="project-tab" id="ptab-issues" style="display:none"></div>
        <div class="project-tab" id="ptab-tools" style="display:none"></div>
        <div class="project-tab" id="ptab-labor" style="display:none"></div>
        <div class="project-tab" id="ptab-finance" style="display:none"></div>
        <div class="project-tab" id="ptab-docs" style="display:none"></div>
        <div class="project-tab" id="ptab-log" style="display:none"></div>
      </div>
    </div>

    <!-- TASKS -->
    <div class="view" id="view-tasks">
      <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap" id="taskFilterChips"></div>
      <div class="card"><div style="overflow-x:auto"><table class="tbl">
        <thead><tr><th>Task</th><th>Project</th><th>Assigned To</th><th>Due Date</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="taskRows"></tbody>
      </table></div></div>
    </div>

    <!-- ISSUES -->
    <div class="view" id="view-issues">
      <div class="card"><div style="overflow-x:auto"><table class="tbl">
        <thead><tr><th>Issue</th><th>Project</th><th>Severity</th><th>Raised By</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="issueRows"></tbody>
      </table></div></div>
    </div>

    <!-- MATERIALS -->
    <div class="view" id="view-materials">
      <div class="card"><div style="overflow-x:auto"><table class="tbl">
        <thead><tr><th>Material</th><th>Project</th><th>Required</th><th>Ordered</th><th>Delivered</th><th>Remaining</th><th>Batches</th><th>Need By</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="materialRows"></tbody>
      </table></div></div>
    </div>

    <!-- TOOLS -->
    <div class="view" id="view-tools">
      <div class="card"><div style="overflow-x:auto"><table class="tbl">
        <thead><tr><th>Tool</th><th>Project</th><th>Required</th><th>Mobilized</th><th>Shortfall</th><th>Need By</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="toolRows"></tbody>
      </table></div></div>
    </div>

    <!-- LABOR -->
    <div class="view" id="view-labor">
      <div class="card"><div style="overflow-x:auto"><table class="tbl">
        <thead><tr><th>Trade</th><th>Project</th><th>Required</th><th>Deployed</th><th>Shortfall</th><th>Mob. Date</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="laborRows"></tbody>
      </table></div></div>
    </div>

    <!-- FINANCE -->
    <div class="view" id="view-finance">
      <div class="stats-row" id="finStats"></div>
      <div class="card"><div style="overflow-x:auto"><table class="tbl">
        <thead><tr><th>Project</th><th>Type</th><th>Description</th><th>Amount</th><th>Date</th><th>Status</th></tr></thead>
        <tbody id="finRows"></tbody>
      </table></div></div>
    </div>

    <!-- DOCUMENTS -->
    <div class="view" id="view-documents">
      <div class="card"><div style="overflow-x:auto"><table class="tbl">
        <thead><tr><th>Document</th><th>Project</th><th>Type</th><th>By</th><th>Date</th><th>Status</th><th>Files</th></tr></thead>
        <tbody id="docRows"></tbody>
      </table></div></div>
    </div>

    <!-- REPORTS -->
    <div class="view" id="view-reports">
      <div class="card">
        <div class="card-title">üìä Report Generator ‚Äî Excel &amp; PDF with Custom Date Range</div>
        <div class="form-grid" style="margin-bottom:14px">
          <div class="field">
            <label>Report Type</label>
            <select id="rpt-type">
              <option value="project">Projects Summary</option>
              <option value="tasks">Tasks Report</option>
              <option value="issues">Issues Report</option>
              <option value="materials">Materials &amp; Procurement</option>
              <option value="delivery">Delivery Batches</option>
              <option value="labor">Labor / Manpower</option>
              <option value="tools">Tools &amp; Equipment</option>
              <option value="finance">Finance &amp; Payments</option>
              <option value="documents">Documents Register</option>
              <option value="mir">MIR / WIR Register</option>
              <option value="site">Site Daily Log</option>
              <option value="full">Full Report (All Sections)</option>
            </select>
          </div>
          <div class="field">
            <label>Filter by Project</label>
            <select id="rpt-project"><option value="all">All Projects</option></select>
          </div>
          <div class="field">
            <label>From Date</label>
            <input id="rpt-from" type="date">
          </div>
          <div class="field">
            <label>To Date</label>
            <input id="rpt-to" type="date">
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn btn-primary" onclick="generateReport('pdf')">üìÑ Download PDF</button>
          <button class="btn btn-success" onclick="generateReport('excel')">üìä Download Excel/CSV</button>
          <button class="btn btn-outline" onclick="previewReport()">üëÅ Preview</button>
          <span style="font-size:11px;color:var(--muted)">Leave dates blank for all records</span>
        </div>
      </div>
      <div id="reportPreviewArea"></div>
      <div class="card-title" style="padding:0 4px;margin-top:4px">Project Overview Cards</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px" id="reportCards"></div>
    </div>

    <!-- FILES -->
    <div class="view" id="view-files">
      <div class="card">
        <div class="card-title">üìÅ Files ‚Äî Stored in Your Google Drive</div>
        <div class="alert alert-info" style="margin-bottom:14px">Files you attach to revisions, MIRs, documents etc. are stored in your <b>Google Drive</b> under a folder called <b>"FacadeOps Files"</b>. Access from any device at <a href="https://drive.google.com" target="_blank" style="color:var(--accent2)">drive.google.com</a>. Max 25 MB per file. 15 GB free storage.</div>
        <div id="fileManagerList"><div style="color:var(--muted);padding:20px">Sign in with Google to view your files.</div></div>
      </div>
    </div>

    <!-- TEAM -->
    <div class="view" id="view-team">
      <div class="card" style="max-width:750px">
        <div class="card-title">Team Members &amp; WhatsApp Notifications</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:14px">Add team members with WhatsApp numbers. Tasks assigned to them will auto-generate a WhatsApp message.</p>
        <div id="teamList" style="margin-bottom:14px"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:end">
          <div class="field"><label>Name</label><input id="tm-name" placeholder="e.g. Rahul Sharma"></div>
          <div class="field"><label>WhatsApp (with country code)</label><input id="tm-phone" placeholder="919876543210"></div>
          <div class="field"><label>Role</label><select id="tm-role"><option>Drawing Team</option><option>Estimation</option><option>Procurement</option><option>Finance</option><option>Admin</option><option>Site Supervisor</option><option>Other</option></select></div>
          <button class="btn btn-primary" onclick="addTeamMember()" style="height:36px;margin-top:auto">+ Add</button>
        </div>
        <div class="alert alert-info" style="margin-top:12px">India format: <b>91</b> + 10-digit mobile. Example: <b>919876543210</b> ‚Äî No +, no spaces, no dashes.</div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- ===================== MODALS ===================== -->

<!-- NEW/EDIT PROJECT -->
<div class="modal-overlay" id="modal-addProject">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="addProjectTitle">NEW PROJECT</div><button class="close-btn" onclick="closeModal('addProject')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="np-id">
      <div class="form-grid">
        <div class="field form-full"><label>Project Name *</label><input id="np-name" placeholder="e.g. Wagle Trade Centre Facade"></div>
        <div class="field form-full"><label>Client / Company</label><input id="np-client"></div>
        <div class="field"><label>Project Type</label><select id="np-type"><option>Curtain Wall</option><option>Aluminium Cladding</option><option>Glass Facade</option><option>Composite Panels</option><option>Stone Cladding</option><option>Mixed Facade</option></select></div>
        <div class="field"><label>Current Stage</label><select id="np-stage"><option>Enquiry</option><option>Estimation</option><option>Tender Submitted</option><option>Contract Signed</option><option>Drawing</option><option>Material Approval</option><option>Fabrication</option><option>Site Installation</option><option>Snagging</option><option>Handover</option></select></div>
        <div class="field"><label>Start Date</label><input id="np-start" type="date"></div>
        <div class="field"><label>Completion Deadline</label><input id="np-end" type="date"></div>
        <div class="field form-full"><label>Site Address / Location</label><input id="np-location"></div>
        <div class="field form-full"><label>Scope of Work</label><textarea id="np-desc"></textarea></div>
        <div class="field"><label>Consultant / Architect</label><input id="np-consultant"></div>
        <div class="field"><label>Main Contractor</label><input id="np-mc"></div>
      </div>
      <div style="margin-top:16px;padding:14px;background:var(--surface2);border-radius:8px;border:1px solid var(--border)">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:700;margin-bottom:12px">Project Value ‚Äî Fill what is known at this stage</div>
        <div class="form-grid">
          <div class="field"><label>Estimated Value (Rs.) ‚Äî Enquiry stage</label><input id="np-estimated" type="number" placeholder="Rough estimate"></div>
          <div class="field"><label>Quoted / Tender Value (Rs.)</label><input id="np-quoted" type="number" placeholder="Value quoted to client"></div>
          <div class="field"><label>Awarded / Contract Value (Rs.)</label><input id="np-value" type="number" placeholder="Final awarded amount"></div>
          <div class="field"><label>Revised Value (Rs.) ‚Äî After Variations</label><input id="np-revised" type="number" placeholder="After variations"></div>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:8px">Fill only what applies. You can update anytime via Edit Project.</div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addProject')">Cancel</button><button class="btn btn-primary" id="saveProjectBtn" onclick="saveProject()">Create Project</button></div>
  </div>
</div>

<!-- ADD VARIATION -->
<div class="modal-overlay" id="modal-addVariation">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ADD VARIATION ORDER</div><button class="close-btn" onclick="closeModal('addVariation')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field form-full"><label>Description *</label><input id="vo-desc" placeholder="e.g. Additional aluminium louvres at Level 5"></div>
        <div class="field"><label>VO Number</label><input id="vo-no" placeholder="VO-001"></div>
        <div class="field"><label>Type</label><select id="vo-type"><option>Addition (Extra Work)</option><option>Deduction (Omission)</option></select></div>
        <div class="field"><label>Amount (Rs.)</label><input id="vo-amount" type="number" value="0"></div>
        <div class="field"><label>Date</label><input id="vo-date" type="date"></div>
        <div class="field"><label>Status</label><select id="vo-status"><option>Pending Approval</option><option>Approved</option><option>Rejected</option></select></div>
        <div class="field form-full"><label>Remarks</label><textarea id="vo-remarks" rows="2"></textarea></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addVariation')">Cancel</button><button class="btn btn-primary" onclick="addVariation()">Save Variation</button></div>
  </div>
</div>

<!-- ADD TASK -->
<div class="modal-overlay" id="modal-addTask">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ADD TASK</div><button class="close-btn" onclick="closeModal('addTask')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field form-full"><label>Task Description *</label><input id="at-task" placeholder="e.g. Submit shop drawings for approval"></div>
        <div class="field"><label>Project</label><select id="at-project"></select></div>
        <div class="field"><label>Assign To</label><select id="at-assign" onchange="updateWAPreview()"></select></div>
        <div class="field"><label>Due Date</label><input id="at-due" type="date" onchange="updateWAPreview()"></div>
        <div class="field"><label>Priority</label><select id="at-priority" onchange="updateWAPreview()"><option>High</option><option selected>Medium</option><option>Low</option></select></div>
        <div class="field form-full"><label>Notes</label><input id="at-notes" onchange="updateWAPreview()"></div>
      </div>
      <div id="wa-preview-box" style="display:none" class="wa-preview">
        <div style="font-size:10px;color:var(--wa);font-weight:700;margin-bottom:6px">üì± WHATSAPP MESSAGE PREVIEW</div>
        <pre id="wa-preview-text" style="font-size:11px;color:var(--text);white-space:pre-wrap;font-family:'DM Sans',sans-serif"></pre>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addTask')">Cancel</button><button class="btn btn-primary" id="addTaskBtn" onclick="addTask()">Save Task</button></div>
  </div>
</div>

<!-- EDIT TASK -->
<div class="modal-overlay" id="modal-editTask">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">EDIT TASK</div><button class="close-btn" onclick="closeModal('editTask')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="et-id">
      <div class="form-grid">
        <div class="field form-full"><label>Task *</label><input id="et-task"></div>
        <div class="field"><label>Assign To</label><select id="et-assign"></select></div>
        <div class="field"><label>Due Date</label><input id="et-due" type="date"></div>
        <div class="field"><label>Priority</label><select id="et-priority"><option>High</option><option>Medium</option><option>Low</option></select></div>
        <div class="field"><label>Status</label><select id="et-status"><option>Pending</option><option>In Progress</option><option>Done</option></select></div>
        <div class="field form-full"><label>Notes</label><input id="et-notes"></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('editTask')">Cancel</button><button class="btn btn-primary" onclick="saveEditTask()">Save</button></div>
  </div>
</div>

<!-- ADD REVISION -->
<div class="modal-overlay" id="modal-addRevision">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ADD REVISION / SUBMISSION</div><button class="close-btn" onclick="closeModal('addRevision')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field form-full"><label>Title *</label><input id="rv-title" placeholder="e.g. Shop Drawing ‚Äî Typical Floor Plan"></div>
        <div class="field"><label>Type</label><select id="rv-type"><option>Drawing Submission</option><option>Quotation Revision</option><option>Material Submittal</option><option>Method Statement</option><option>RFI</option><option>NCR</option><option>Other</option></select></div>
        <div class="field"><label>Revision No.</label><input id="rv-rev" placeholder="R0, R1, R2..."></div>
        <div class="field"><label>Submitted To</label><input id="rv-to" placeholder="Consultant / Client name"></div>
        <div class="field"><label>Submitted By</label><input id="rv-by"></div>
        <div class="field"><label>Date</label><input id="rv-date" type="date"></div>
        <div class="field form-full"><label>Status</label><select id="rv-status"><option>Submitted</option><option>Under Review</option><option>Approved</option><option>Approved with Comments</option><option>Rejected ‚Äì Revise &amp; Resubmit</option></select></div>
        <div class="field form-full"><label>Notes</label><textarea id="rv-notes" rows="2"></textarea></div>
        <div class="field form-full"><label>Attach File (uploaded to Google Drive, max 25 MB each)</label>
          <input type="file" id="rv-file" multiple style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text);font-size:11px">
        </div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addRevision')">Cancel</button><button class="btn btn-primary" id="btn-rv-save" onclick="addRevision()">Save Revision</button></div>
  </div>
</div>

<!-- ADD MATERIAL -->
<div class="modal-overlay" id="modal-addMaterial">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ADD MATERIAL</div><button class="close-btn" onclick="closeModal('addMaterial')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field form-full"><label>Material Name *</label><input id="am-name" placeholder="e.g. Aluminium Extrusion Profile 6063"></div>
        <div class="field"><label>Project</label><select id="am-project"></select></div>
        <div class="field"><label>Unit</label><select id="am-unit"><option>Nos</option><option>Kg</option><option>MT</option><option>Sqm</option><option>Rmt</option><option>Set</option><option>Lot</option></select></div>
        <div class="field"><label>Qty Required</label><input id="am-qty" type="number" value="0"></div>
        <div class="field"><label>Qty Ordered / Procured</label><input id="am-procured" type="number" value="0"></div>
        <div class="field"><label>Need By Date</label><input id="am-needby" type="date"></div>
        <div class="field"><label>Supplier</label><input id="am-supplier"></div>
        <div class="field"><label>Rate (Rs. per unit)</label><input id="am-rate" type="number" value="0"></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addMaterial')">Cancel</button><button class="btn btn-primary" onclick="addMaterial()">Save</button></div>
  </div>
</div>

<!-- EDIT MATERIAL -->
<div class="modal-overlay" id="modal-editMaterial">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">EDIT MATERIAL</div><button class="close-btn" onclick="closeModal('editMaterial')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="em-id">
      <div class="form-grid">
        <div class="field form-full"><label>Material Name</label><input id="em-name"></div>
        <div class="field"><label>Unit</label><select id="em-unit"><option>Nos</option><option>Kg</option><option>MT</option><option>Sqm</option><option>Rmt</option><option>Set</option><option>Lot</option></select></div>
        <div class="field"><label>Qty Required</label><input id="em-qty" type="number"></div>
        <div class="field"><label>Qty Ordered</label><input id="em-procured" type="number"></div>
        <div class="field"><label>Need By</label><input id="em-needby" type="date"></div>
        <div class="field"><label>Supplier</label><input id="em-supplier"></div>
        <div class="field"><label>Rate</label><input id="em-rate" type="number"></div>
        <div class="field form-full"><label>Remarks</label><input id="em-remarks"></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('editMaterial')">Cancel</button><button class="btn btn-primary" onclick="saveEditMaterial()">Save</button></div>
  </div>
</div>

<!-- ADD BATCH (Delivery Challan) -->
<div class="modal-overlay" id="modal-addBatch">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ADD DELIVERY BATCH</div><button class="close-btn" onclick="closeModal('addBatch')">‚úï</button></div>
    <div class="modal-body">
      <div class="alert alert-info" id="batch-material-info" style="margin-bottom:12px"></div>
      <div class="form-grid">
        <div class="field"><label>Challan / DC No.</label><input id="bt-no" placeholder="DC-001"></div>
        <div class="field"><label>Qty Delivered</label><input id="bt-qty" type="number" value="0"></div>
        <div class="field"><label>Delivery Date</label><input id="bt-date" type="date"></div>
        <div class="field"><label>Vehicle / Transport</label><input id="bt-vehicle" placeholder="Truck no. / Lorry"></div>
        <div class="field"><label>Received By</label><input id="bt-received" placeholder="Site in-charge name"></div>
        <div class="field"><label>Condition</label><select id="bt-condition"><option>Good</option><option>Minor Damage</option><option>Damaged ‚Äì Returned</option><option>Partial</option></select></div>
        <div class="field form-full"><label>Remarks</label><input id="bt-remarks"></div>
        <div class="field form-full"><label>Attach Delivery Challan / Photos (Google Drive, max 25 MB)</label>
          <input type="file" id="bt-file" multiple style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text);font-size:11px">
        </div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addBatch')">Cancel</button><button class="btn btn-primary" id="btn-bt-save" onclick="addBatch()">Save Batch</button></div>
  </div>
</div>

<!-- ADD TEST CERT -->
<div class="modal-overlay" id="modal-addCert">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ADD TEST CERTIFICATE</div><button class="close-btn" onclick="closeModal('addCert')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field form-full"><label>Certificate Name *</label><input id="ct-name" placeholder="e.g. AAMA 2605 Powder Coating Test"></div>
        <div class="field"><label>Material</label><input id="ct-material" placeholder="Material being tested"></div>
        <div class="field"><label>Certificate No.</label><input id="ct-no"></div>
        <div class="field"><label>Issued By</label><input id="ct-issuer" placeholder="Lab / Agency name"></div>
        <div class="field"><label>Test Date</label><input id="ct-date" type="date"></div>
        <div class="field"><label>Valid Until</label><input id="ct-valid" type="date"></div>
        <div class="field form-full"><label>Status</label><select id="ct-status"><option>Valid</option><option>Submitted to Consultant</option><option>Approved</option><option>Rejected</option><option>Expired</option></select></div>
        <div class="field form-full"><label>Notes</label><textarea id="ct-notes" rows="2"></textarea></div>
        <div class="field form-full"><label>Attach Certificate (Google Drive, max 25 MB)</label>
          <input type="file" id="ct-file" multiple style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text);font-size:11px">
        </div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addCert')">Cancel</button><button class="btn btn-primary" id="btn-ct-save" onclick="addCert()">Save Certificate</button></div>
  </div>
</div>

<!-- ADD MIR / WIR -->
<div class="modal-overlay" id="modal-addMIR">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">MATERIAL / WORK INSPECTION REPORT</div><button class="close-btn" onclick="closeModal('addMIR')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field form-full"><label>Report Title *</label><input id="mir-title" placeholder="e.g. MIR-001 Aluminium Profile Inspection"></div>
        <div class="field"><label>Type</label><select id="mir-type"><option>MIR - Material Inspection Report</option><option>WIR - Work Inspection Report</option></select></div>
        <div class="field"><label>Report Number</label><input id="mir-no" placeholder="MIR-001"></div>
        <div class="field"><label>Material / Work Being Inspected</label><input id="mir-material" placeholder="Material or work item"></div>
        <div class="field"><label>Inspection Date</label><input id="mir-date" type="date"></div>
        <div class="field"><label>Inspected By</label><input id="mir-by" placeholder="Inspector name"></div>
        <div class="field"><label>Client Representative</label><input id="mir-client-rep" placeholder="Client/consultant who will sign"></div>
        <div class="field"><label>Inspection Result</label><select id="mir-result"><option>Pass</option><option>Pass with Conditions</option><option>Fail ‚Äì Rejected</option><option>Pending Inspection</option></select></div>
        <div class="field"><label>Signature Status</label><select id="mir-sig"><option>Pending Signature</option><option>Signed ‚Äì Approved</option><option>Signed ‚Äì Rejected</option><option>Awaiting Client Visit</option></select></div>
        <div class="field form-full"><label>Inspection Findings / Notes</label><textarea id="mir-notes" rows="3" placeholder="Describe inspection findings..."></textarea></div>
        <div class="field form-full"><label>Attach Report / Photos (Google Drive, max 25 MB)</label>
          <input type="file" id="mir-file" multiple style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text);font-size:11px">
        </div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addMIR')">Cancel</button><button class="btn btn-primary" id="btn-mir-save" onclick="addMIR()">Save Report</button></div>
  </div>
</div>

<!-- ADD ISSUE -->
<div class="modal-overlay" id="modal-addIssue">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">RAISE ISSUE</div><button class="close-btn" onclick="closeModal('addIssue')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field form-full"><label>Issue Title *</label><input id="is-title" placeholder="Brief description of issue"></div>
        <div class="field"><label>Project</label><select id="is-project"></select></div>
        <div class="field"><label>Severity</label><select id="is-severity"><option>Critical</option><option>High</option><option>Medium</option><option>Low</option></select></div>
        <div class="field"><label>Category</label><select id="is-cat"><option>Design Issue</option><option>Material Issue</option><option>Site / Installation Issue</option><option>Client Issue</option><option>Subcontractor Issue</option><option>Safety Issue</option><option>Financial Issue</option><option>Other</option></select></div>
        <div class="field"><label>Raised By</label><select id="is-by"><option>Manager</option><option>Site Supervisor</option><option>Drawing Team</option><option>Client</option><option>Consultant</option><option>Other</option></select></div>
        <div class="field"><label>Date Raised</label><input id="is-date" type="date"></div>
        <div class="field"><label>Assigned To</label><select id="is-assign"></select></div>
        <div class="field"><label>Target Resolution Date</label><input id="is-target" type="date"></div>
        <div class="field form-full"><label>Detailed Description</label><textarea id="is-desc" rows="3"></textarea></div>
        <div class="field form-full"><label>Attach File (Google Drive, max 25 MB)</label>
          <input type="file" id="is-file" multiple style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text);font-size:11px">
        </div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addIssue')">Cancel</button><button class="btn btn-primary" id="btn-is-save" onclick="addIssue()">Raise Issue</button></div>
  </div>
</div>

<!-- EDIT ISSUE -->
<div class="modal-overlay" id="modal-editIssue">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">EDIT ISSUE</div><button class="close-btn" onclick="closeModal('editIssue')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="ei-id">
      <div class="form-grid">
        <div class="field form-full"><label>Title</label><input id="ei-title"></div>
        <div class="field"><label>Severity</label><select id="ei-severity"><option>Critical</option><option>High</option><option>Medium</option><option>Low</option></select></div>
        <div class="field"><label>Status</label><select id="ei-status"><option>Open</option><option>In Progress</option><option>Resolved</option><option>Closed</option></select></div>
        <div class="field"><label>Target Date</label><input id="ei-target" type="date"></div>
        <div class="field form-full"><label>Description</label><textarea id="ei-desc" rows="3"></textarea></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('editIssue')">Cancel</button><button class="btn btn-primary" onclick="saveEditIssue()">Save</button></div>
  </div>
</div>

<!-- ADD TOOL -->
<div class="modal-overlay" id="modal-addTool">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ADD TOOL / EQUIPMENT</div><button class="close-btn" onclick="closeModal('addTool')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field form-full"><label>Tool Name *</label><input id="tl-name" placeholder="e.g. Gondola, Drill Machine, Scaffold"></div>
        <div class="field"><label>Project</label><select id="tl-project"></select></div>
        <div class="field"><label>Qty Required</label><input id="tl-qty" type="number" value="1"></div>
        <div class="field"><label>Qty Mobilized</label><input id="tl-avail" type="number" value="0"></div>
        <div class="field"><label>Need By Date</label><input id="tl-needby" type="date"></div>
        <div class="field"><label>Source</label><select id="tl-source"><option>Owned</option><option>Rented</option><option>To Purchase</option></select></div>
        <div class="field form-full"><label>Remarks</label><input id="tl-remarks"></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addTool')">Cancel</button><button class="btn btn-primary" onclick="addTool()">Save</button></div>
  </div>
</div>

<!-- ADD LABOR -->
<div class="modal-overlay" id="modal-addLabor">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ADD LABOR / MANPOWER</div><button class="close-btn" onclick="closeModal('addLabor')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field form-full"><label>Trade / Role *</label><input id="lb-trade" placeholder="e.g. Aluminium Fabricator, Glass Fixer"></div>
        <div class="field"><label>Project</label><select id="lb-project"></select></div>
        <div class="field"><label>No. Required</label><input id="lb-req" type="number" value="1"></div>
        <div class="field"><label>No. Deployed</label><input id="lb-dep" type="number" value="0"></div>
        <div class="field"><label>Mobilization Date</label><input id="lb-mobdate" type="date"></div>
        <div class="field"><label>Source</label><select id="lb-source"><option>Own Workers</option><option>Subcontractor</option><option>Daily Hire</option></select></div>
        <div class="field form-full"><label>Remarks</label><input id="lb-remarks"></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addLabor')">Cancel</button><button class="btn btn-primary" onclick="addLabor()">Save</button></div>
  </div>
</div>

<!-- ADD FINANCE -->
<div class="modal-overlay" id="modal-addFinance">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ADD FINANCE ENTRY</div><button class="close-btn" onclick="closeModal('addFinance')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field"><label>Project</label><select id="fn-project"></select></div>
        <div class="field"><label>Type</label><select id="fn-type"><option>Invoice to Client</option><option>Payment from Client</option><option>Material Cost</option><option>Labor Cost</option><option>Equipment Cost</option><option>Subcontractor Payment</option><option>Other Expense</option></select></div>
        <div class="field form-full"><label>Description</label><input id="fn-desc" placeholder="e.g. Invoice #3 ‚Äî 40% progress billing"></div>
        <div class="field"><label>Amount (Rs.)</label><input id="fn-amount" type="number" value="0"></div>
        <div class="field"><label>Date</label><input id="fn-date" type="date"></div>
        <div class="field"><label>Status</label><select id="fn-status"><option>Pending</option><option>Paid</option><option>Received</option><option>Overdue</option></select></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addFinance')">Cancel</button><button class="btn btn-primary" onclick="addFinance()">Save</button></div>
  </div>
</div>

<!-- ADD DOCUMENT -->
<div class="modal-overlay" id="modal-addDocument">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ADD DOCUMENT</div><button class="close-btn" onclick="closeModal('addDocument')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field form-full"><label>Document Name *</label><input id="dc-name" placeholder="e.g. Shop Drawing Rev 2"></div>
        <div class="field"><label>Project</label><select id="dc-project"></select></div>
        <div class="field"><label>Type</label><select id="dc-type"><option>Shop Drawing</option><option>Material Submittal</option><option>Method Statement</option><option>Risk Assessment</option><option>Inspection Request</option><option>RFI</option><option>MIR - Material Inspection Report</option><option>WIR - Work Inspection Report</option><option>Contract</option><option>BOQ</option><option>Invoice</option><option>Test Certificate</option><option>Photo</option><option>NCR - Non Conformance Report</option><option>Snag List</option><option>As-Built Drawing</option><option>O&M Manual</option><option>Other</option></select></div>
        <div class="field"><label>Submitted By</label><select id="dc-by"><option>Drawing Team</option><option>Estimation</option><option>Procurement</option><option>Finance</option><option>Admin</option><option>Site Supervisor</option><option>Manager</option></select></div>
        <div class="field"><label>Date</label><input id="dc-date" type="date"></div>
        <div class="field"><label>Status</label><select id="dc-status"><option>Submitted</option><option>Approved</option><option>Approved with Comments</option><option>Rejected</option><option>Under Review</option></select></div>
        <div class="field form-full"><label>Notes</label><textarea id="dc-notes" rows="2"></textarea></div>
        <div class="field form-full"><label>Attach File (Google Drive, max 25 MB)</label>
          <input type="file" id="dc-file" multiple style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text);font-size:11px">
        </div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addDocument')">Cancel</button><button class="btn btn-primary" id="btn-dc-save" onclick="addDocument()">Save</button></div>
  </div>
</div>

<!-- ADD DAILY LOG -->
<div class="modal-overlay" id="modal-addLog">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">DAILY LOG ENTRY</div><button class="close-btn" onclick="closeModal('addLog')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field"><label>Date</label><input id="lg-date" type="date"></div>
        <div class="field"><label>Weather</label><select id="lg-weather"><option>Sunny</option><option>Cloudy</option><option>Windy</option><option>Rainy</option><option>Stopped - Weather</option></select></div>
        <div class="field"><label>Workers on Site</label><input id="lg-workers" type="number" value="0"></div>
        <div class="field"><label>Progress % Today</label><input id="lg-prog" type="number" min="0" max="100" value="0"></div>
        <div class="field form-full"><label>Work Done Today</label><textarea id="lg-work" rows="3"></textarea></div>
        <div class="field form-full"><label>Issues / Problems</label><textarea id="lg-issues" rows="2"></textarea></div>
        <div class="field form-full"><label>Instructions Given</label><textarea id="lg-instructions" rows="2"></textarea></div>
        <div class="field form-full"><label>Attach Photos / Reports (Google Drive, max 25 MB)</label>
          <input type="file" id="lg-file" multiple style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text);font-size:11px">
        </div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('addLog')">Cancel</button><button class="btn btn-primary" id="btn-lg-save" onclick="addLog()">Save Log</button></div>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// ============================================================
// CONFIG
// ============================================================
const GOOGLE_CLIENT_ID = '741609954421-nin44kc4ct0cskhpgd64rjtrkcc8v34e.apps.googleusercontent.com';
const DRIVE_FILE_NAME = DRIVE_DB_FILE;
const DRIVE_DB_FILE    = 'facadeops_data_v3.json';
const DRIVE_FOLDER_NAME = 'FacadeOps Files';
// Scopes for initial sign-in (drive.appdata for DB, userinfo for profile)
const SCOPES_BASE = [
  'https://www.googleapis.com/auth/drive.appdata',
  'https://www.googleapis.com/auth/userinfo.email',
  'https://www.googleapis.com/auth/userinfo.profile'
].join(' ');
// Full scopes including file upload (drive.file)
const SCOPES_FULL = [
  'https://www.googleapis.com/auth/drive.appdata',
  'https://www.googleapis.com/auth/drive.file',
  'https://www.googleapis.com/auth/userinfo.email',
  'https://www.googleapis.com/auth/userinfo.profile'
].join(' ');

let token        = null;   // OAuth access token
let driveFileId  = null;   // ID of the DB JSON file in appDataFolder
let driveFolderId = null;  // ID of "FacadeOps Files" folder
let syncTimer    = null;
let isDemoMode   = false;

// ============================================================
// DATABASE
// ============================================================
let db = {
  projects:[], tasks:[], materials:[], batches:[], certs:[], mir:[],
  issues:[], tools:[], labor:[], finance:[], documents:[], logs:[],
  revisions:[], team:[], activity:[]
};

function ensureDBFields() {
  ['projects','tasks','materials','batches','certs','mir','issues','tools','labor',
   'finance','documents','logs','revisions','team','activity'].forEach(k => {
    if (!db[k]) db[k] = [];
  });
}

// ============================================================
// LOCAL STORAGE ‚Äî TRIPLE BACKUP
// ============================================================
function saveLocal() {
  const s = JSON.stringify(db);
  ['facadeops_v3a','facadeops_v3b','facadeops_v3c'].forEach(k => {
    try { localStorage.setItem(k, s); } catch(e) {}
  });
}

function loadLocal() {
  const keys = ['facadeops_v3a','facadeops_v3b','facadeops_v3c',
                'facadeops_v3_primary','facadeops_v2'];
  let best = null, bestCount = -1;
  for (const k of keys) {
    try {
      const s = localStorage.getItem(k);
      if (!s) continue;
      const parsed = JSON.parse(s);
      if (parsed && Array.isArray(parsed.projects) && parsed.projects.length > bestCount) {
        best = parsed;
        bestCount = parsed.projects.length;
      }
    } catch(e) {}
  }
  if (best) { db = best; ensureDBFields(); }
  else ensureDBFields();
}

// ============================================================
// AUTH
// ============================================================
function handleGoogleSignIn() {
  const statusEl = document.getElementById('authStatus');
  statusEl.textContent = 'Loading Google sign-in services...';
  let attempts = 0;
  function tryInit() {
    attempts++;
    if (!window.google || !window.google.accounts || !window.google.accounts.oauth2) {
      if (attempts > 30) {
        statusEl.textContent = 'Google services failed to load. Check your internet connection and try refreshing.';
        return;
      }
      setTimeout(tryInit, 400);
      return;
    }
    statusEl.textContent = 'Opening Google sign-in...';
    try {
      const client = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES_FULL,
        callback: async resp => {
          if (resp.error) {
            if (resp.error === 'popup_closed_by_user' || resp.error === 'access_denied') {
              // Try with base scopes only (without drive.file)
              statusEl.textContent = 'Retrying with basic permissions...';
              trySignInBasic();
            } else {
              statusEl.textContent = 'Sign-in error: ' + resp.error + '. Please try again.';
            }
            return;
          }
          token = resp.access_token;
          statusEl.textContent = 'Signed in! Loading your data...';
          await initAfterAuth();
        }
      });
      client.requestAccessToken({}); // no forced consent ‚Äî lets existing tokens work silently
    } catch(e) {
      statusEl.textContent = 'Sign-in failed: ' + e.message + '. Try refreshing the page.';
    }
  }

  function trySignInBasic() {
    // Fallback: sign in without drive.file scope
    try {
      const client = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES_BASE,
        callback: async resp => {
          if (resp.error) {
            statusEl.textContent = 'Sign-in failed: ' + resp.error + '. Please try "Continue without Google" or refresh and try again.';
            return;
          }
          token = resp.access_token;
          statusEl.textContent = 'Signed in (without file upload). Loading data...';
          await initAfterAuth();
        }
      });
      client.requestAccessToken({ prompt: 'consent' });
    } catch(e) {
      statusEl.textContent = 'Sign-in failed. Please refresh the page and try again.';
    }
  }

  tryInit();
}

async function initAfterAuth() {
  try {
    const r = await fetch('https://www.googleapis.com/oauth2/v2/userinfo',
      { headers: { Authorization: 'Bearer ' + token } });
    const u = await r.json();
    document.getElementById('userInfo').textContent = u.email || u.name || 'Signed in';
    showApp();
    loadLocal();                          // load local first
    setSyncStatus('syncing', 'Syncing with Google Drive...');
    await loadFromDrive();                // then merge with Drive
    ensureDriveFolder();                  // prepare files folder (non-blocking)
    navigate('dashboard');
  } catch(e) {
    document.getElementById('authStatus').textContent = 'Error: ' + e.message;
  }
}

function startDemoMode() {
  isDemoMode = true;
  document.getElementById('userInfo').textContent = 'Local mode ‚Äî no Google sync';
  showApp();
  loadLocal();
  setSyncStatus('error', 'Local mode ‚Äî data saved to browser only');
  navigate('dashboard');
}

function showApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainApp').style.display   = 'flex';
}

function handleSignOut() {
  if (!confirm('Sign out?')) return;
  if (window.google && window.google.accounts && token)
    google.accounts.oauth2.revoke(token);
  token = null; driveFileId = null; driveFolderId = null;
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('mainApp').style.display   = 'none';
}

// ============================================================
// DRIVE SYNC ‚Äî DB FILE
// ============================================================
function setSyncStatus(state, msg) {
  const b = document.getElementById('syncBar');
  b.className = state; b.textContent = msg;
}

async function loadFromDrive() {
  if (!token) return;
  try {
    const r = await fetch(
      'https://www.googleapis.com/drive/v3/files' +
      '?spaces=appDataFolder&q=name%3D%22' + DRIVE_DB_FILE + '%22&fields=files(id,name,modifiedTime)',
      { headers: { Authorization: 'Bearer ' + token } }
    );
    if (!r.ok) throw new Error('List failed ' + r.status);
    const list = await r.json();
    if (list.files && list.files.length > 0) {
      driveFileId = list.files[0].id;
      const fr = await fetch(
        'https://www.googleapis.com/drive/v3/files/' + driveFileId + '?alt=media',
        { headers: { Authorization: 'Bearer ' + token } }
      );
      if (!fr.ok) throw new Error('Read failed ' + fr.status);
      const data = await fr.json();
      if (data && Array.isArray(data.projects)) {
        const driveCount = data.projects.length;
        const localCount = db.projects.length;
        if (driveCount >= localCount) {
          db = data; ensureDBFields(); saveLocal();
          setSyncStatus('synced', 'Synced ‚Äî ' + db.projects.length + ' projects ‚Äî ' + now());
        } else {
          setSyncStatus('syncing', 'Local newer ‚Äî pushing to Drive...');
          await saveToDrive();
        }
      } else {
        setSyncStatus('synced', 'Connected ‚Äî no data on Drive yet');
      }
    } else {
      setSyncStatus('synced', 'Connected ‚Äî will create file on first save');
    }
  } catch(e) {
    setSyncStatus('error', 'Drive load issue (' + e.message + ') ‚Äî using local backup');
  }
}

async function saveToDrive() {
  if (isDemoMode || !token) { saveLocal(); return; }
  setSyncStatus('syncing', 'Saving to Google Drive...');
  try {
    const body = JSON.stringify(db);
    if (driveFileId) {
      const r = await fetch(
        'https://www.googleapis.com/upload/drive/v3/files/' + driveFileId + '?uploadType=media',
        { method: 'PATCH', headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' }, body }
      );
      if (!r.ok) throw new Error('Patch failed ' + r.status);
    } else {
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify({
        name: DRIVE_DB_FILE, parents: ['appDataFolder']
      })], { type: 'application/json' }));
      form.append('file', new Blob([body], { type: 'application/json' }));
      const r = await fetch(
        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
        { method: 'POST', headers: { Authorization: 'Bearer ' + token }, body: form }
      );
      if (!r.ok) throw new Error('Create failed ' + r.status);
      const res = await r.json();
      driveFileId = res.id;
    }
    setSyncStatus('synced', 'Saved ‚Äî ' + now()); saveLocal();
  } catch(e) {
    setSyncStatus('error', 'Save failed ‚Äî ' + e.message + ' ‚Äî saved locally'); saveLocal();
  }
}

function saveDB() {
  saveLocal();
  if (syncTimer) clearTimeout(syncTimer);
  syncTimer = setTimeout(saveToDrive, 3000);
}
function syncNow() { saveToDrive(); }
function now() { return new Date().toLocaleTimeString('en-IN'); }

// ============================================================
// DRIVE FILE UPLOAD
// ============================================================
async function ensureDriveFolder() {
  if (!token || driveFolderId) return driveFolderId;
  try {
    const q = encodeURIComponent("name='" + DRIVE_FOLDER_NAME + "' and mimeType='application/vnd.google-apps.folder' and trashed=false");
    const r = await fetch('https://www.googleapis.com/drive/v3/files?q=' + q + '&fields=files(id)',
      { headers: { Authorization: 'Bearer ' + token } });
    const list = await r.json();
    if (list.files && list.files.length > 0) { driveFolderId = list.files[0].id; return driveFolderId; }
    const cr = await fetch('https://www.googleapis.com/drive/v3/files', {
      method: 'POST',
      headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: DRIVE_FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' })
    });
    const folder = await cr.json();
    driveFolderId = folder.id;
    return driveFolderId;
  } catch(e) { console.error('Folder error', e); return null; }
}

async function uploadFilesFromInput(inputId, btnEl) {
  const input = document.getElementById(inputId);
  if (!input || !input.files || !input.files.length) return [];
  if (!token) {
    alert('You must be signed in with Google to upload files. Files are not saved in local/demo mode.');
    return [];
  }
  const fid = await ensureDriveFolder();
  if (!fid) { alert('Could not create Google Drive folder. Check permissions.'); return []; }
  const files = Array.from(input.files);
  const results = [];
  const origText = btnEl ? btnEl.textContent : '';
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (file.size > 25 * 1024 * 1024) {
      alert(file.name + ' is over 25 MB and was skipped.');
      continue;
    }
    if (btnEl) btnEl.textContent = 'Uploading ' + (i + 1) + '/' + files.length + '...';
    try {
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify({ name: file.name, parents: [fid] })], { type: 'application/json' }));
      form.append('file', file);
      const r = await fetch(
        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,mimeType,size,webViewLink',
        { method: 'POST', headers: { Authorization: 'Bearer ' + token }, body: form }
      );
      if (!r.ok) throw new Error('Upload error ' + r.status);
      const res = await r.json();
      await fetch('https://www.googleapis.com/drive/v3/files/' + res.id + '/permissions', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: 'reader', type: 'anyone' })
      });
      results.push({
        driveId: res.id, name: file.name, size: file.size,
        mimeType: res.mimeType || file.type,
        downloadLink: 'https://drive.google.com/uc?export=download&id=' + res.id,
        viewLink: res.webViewLink || ('https://drive.google.com/file/d/' + res.id + '/view')
      });
    } catch(e) { alert('Upload failed: ' + file.name + ' ‚Äî ' + e.message); }
  }
  if (btnEl) btnEl.textContent = origText;
  input.value = '';
  return results;
}

function renderFileList(files) {
  if (!files || !files.length) return '<span style="color:var(--muted);font-size:11px">‚Äî</span>';
  return files.map(f => {
    const icon = /image/.test(f.mimeType) ? 'üñº' : /pdf/.test(f.mimeType) ? 'üìÑ' : 'üìé';
    const kb = Math.round((f.size || 0) / 1024);
    const sz = kb > 1024 ? (kb / 1024).toFixed(1) + 'MB' : kb + 'KB';
    return '<a href="' + (f.downloadLink || f.viewLink || '#') + '" target="_blank" class="attached-file">' + icon + ' ' + f.name + ' <span style="color:var(--muted);font-size:10px">' + sz + '</span></a>';
  }).join('');
}

async function renderFileManager() {
  const el = document.getElementById('fileManagerList');
  if (!el) return;
  if (!token) { el.innerHTML = '<div class="alert alert-warn">Sign in with Google to view files.</div>'; return; }
  el.innerHTML = '<div style="color:var(--muted)">Loading from Google Drive...</div>';
  try {
    const fid = await ensureDriveFolder();
    if (!fid) { el.innerHTML = '<div class="alert alert-danger">Cannot access Drive folder.</div>'; return; }
    const q = encodeURIComponent("'" + fid + "' in parents and trashed=false");
    const r = await fetch(
      'https://www.googleapis.com/drive/v3/files?q=' + q + '&fields=files(id,name,mimeType,size,webViewLink,createdTime)&orderBy=createdTime%20desc&pageSize=100',
      { headers: { Authorization: 'Bearer ' + token } }
    );
    const list = await r.json();
    if (!list.files || !list.files.length) {
      el.innerHTML = '<div class="empty"><div class="empty-icon">üìÅ</div>No files uploaded yet. Attach files to revisions, MIRs, documents, issues etc.</div>';
      return;
    }
    let totalBytes = 0;
    let html = '<div style="overflow-x:auto"><table class="tbl"><thead><tr><th>File</th><th>Type</th><th>Size</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody>';
    list.files.forEach(f => {
      const kb = Math.round((f.size || 0) / 1024);
      const sz = kb > 1024 ? (kb / 1024).toFixed(1) + 'MB' : kb + 'KB';
      totalBytes += (f.size || 0);
      const icon = /image/.test(f.mimeType) ? 'üñº' : /pdf/.test(f.mimeType) ? 'üìÑ' : 'üìé';
      const ext = (f.name.split('.').pop() || '').toUpperCase();
      html += '<tr><td>' + icon + ' <b>' + f.name + '</b></td><td style="font-size:11px">' + ext + '</td><td style="font-size:11px">' + sz + '</td><td style="font-size:11px">' + fmtDate(f.createdTime) + '</td><td><a href="https://drive.google.com/uc?export=download&id=' + f.id + '" target="_blank" class="btn btn-success btn-sm">‚Üì Download</a> <a href="' + f.webViewLink + '" target="_blank" class="btn btn-outline btn-sm">View</a></td></tr>';
    });
    html += '</tbody></table></div>';
    html += '<div style="margin-top:12px;font-size:12px;color:var(--muted)">' + list.files.length + ' files | ' + (totalBytes / 1024 / 1024).toFixed(2) + ' MB | <a href="https://drive.google.com/drive/folders/' + fid + '" target="_blank" style="color:var(--accent2)">Open folder in Drive</a></div>';
    el.innerHTML = html;
  } catch(e) { el.innerHTML = '<div class="alert alert-danger">Error: ' + e.message + '</div>'; }
}

// ============================================================
// HELPERS
// ============================================================
function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }
function inr(n) { return 'Rs.' + Number(n || 0).toLocaleString('en-IN'); }
function gv(id) { const e = document.getElementById(id); return e ? e.value : ''; }

function fmtDate(d) {
  if (!d) return '-';
  if (typeof d === 'string' && d.includes('T')) d = d.split('T')[0];
  if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) {
    const [y, m, day] = d.split('-');
    return day + '-' + m + '-' + y;
  }
  return d;
}

function logActivity(msg) {
  db.activity.unshift({ msg, time: new Date().toLocaleString('en-IN') });
  if (db.activity.length > 50) db.activity.pop();
}

// ============================================================
// NAVIGATION
// ============================================================
let currentView = 'dashboard';
let currentProject = null;

const PROJECT_STAGES = ['Enquiry','Estimation','Tender Submitted','Contract Signed','Drawing',
  'Material Approval','Fabrication','Site Installation','Snagging','Handover'];

function navigate(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const el = document.getElementById('view-' + view);
  if (el) el.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    const oc = n.getAttribute('onclick') || '';
    n.classList.toggle('active', oc.includes("'" + view + "'"));
  });
  currentView = view;
  const titles = {
    dashboard:'DASHBOARD', projects:'PROJECTS', tasks:'TASKS', issues:'ISSUES',
    materials:'MATERIALS', tools:'TOOLS', labor:'LABOR', finance:'FINANCE',
    documents:'DOCUMENTS', reports:'REPORTS', files:'FILES', team:'TEAM & WHATSAPP'
  };
  document.getElementById('pageTitle').textContent = titles[view] || view.toUpperCase();
  const acts = {
    projects: '<button class="btn btn-primary" onclick="openNewProjectModal()">+ New Project</button>',
    tasks:    '<button class="btn btn-primary" onclick="openModal(\'addTask\')">+ Add Task</button>',
    issues:   '<button class="btn btn-primary" onclick="openModal(\'addIssue\')">+ Raise Issue</button>',
    materials:'<button class="btn btn-primary" onclick="openModal(\'addMaterial\')">+ Add Material</button>',
    tools:    '<button class="btn btn-primary" onclick="openModal(\'addTool\')">+ Add Tool</button>',
    labor:    '<button class="btn btn-primary" onclick="openModal(\'addLabor\')">+ Add Labor</button>',
    finance:  '<button class="btn btn-primary" onclick="openModal(\'addFinance\')">+ Add Entry</button>',
    documents:'<button class="btn btn-primary" onclick="openModal(\'addDocument\')">+ Add Document</button>'
  };
  document.getElementById('topbarActions').innerHTML = acts[view] || '';
  if (view === 'dashboard')  renderDashboard();
  if (view === 'projects')   renderProjects();
  if (view === 'tasks')      renderTasks();
  if (view === 'issues')     renderIssuesView();
  if (view === 'materials')  renderMaterialsView();
  if (view === 'tools')      renderToolsView();
  if (view === 'labor')      renderLaborView();
  if (view === 'finance')    renderFinanceView();
  if (view === 'documents')  renderDocumentsView();
  if (view === 'reports')    renderReports();
  if (view === 'files')      renderFileManager();
  if (view === 'team')       renderTeamView();
}

function toggleSidebar() { document.getElementById('sidebar-nav').classList.toggle('open'); }

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard() {
  const tot = db.projects.length;
  const act = db.projects.filter(p => p.stage !== 'Handover').length;
  const ovd = db.tasks.filter(t => t.status !== 'Done' && t.due && new Date(t.due) < new Date()).length;
  const ms  = db.materials.filter(m => m.procured < m.qty).length;
  const oi  = db.issues.filter(i => i.status !== 'Resolved' && i.status !== 'Closed').length;
  document.getElementById('dashStats').innerHTML =
    sc('Total Projects', tot, '') + sc('Active', act, 'var(--accent3)') +
    sc('Overdue Tasks', ovd, 'var(--danger)') + sc('Mat. Shortfalls', ms, 'var(--warn)') +
    sc('Open Issues', oi, oi > 0 ? 'var(--danger)' : 'var(--accent3)');
  let alerts = '';
  db.tasks.filter(t => t.status !== 'Done' && t.due && new Date(t.due) < new Date()).slice(0, 4).forEach(t => {
    const p = db.projects.find(pr => pr.id === t.projectId);
    alerts += '<div class="alert alert-danger">Overdue: <b>' + t.task + '</b>' + (p ? ' ‚Äî ' + p.name : '') + '</div>';
  });
  db.issues.filter(i => i.severity === 'Critical' && i.status !== 'Resolved').slice(0, 3).forEach(i => {
    alerts += '<div class="alert alert-danger">Critical Issue: <b>' + i.title + '</b></div>';
  });
  db.mir.filter(m => m.sigStatus === 'Pending Signature').slice(0, 3).forEach(m => {
    alerts += '<div class="alert alert-info">MIR/WIR pending signature: <b>' + m.title + '</b></div>';
  });
  document.getElementById('dashAlerts').innerHTML = alerts || '<div class="alert alert-success">No urgent alerts ‚Äî all good!</div>';
  document.getElementById('dashActivity').innerHTML = db.activity.slice(0, 10).map(a =>
    '<div style="padding:5px 0;border-bottom:1px solid var(--border);font-size:11px">' + a.msg + '<br><span style="color:var(--muted)">' + a.time + '</span></div>'
  ).join('') || '<span style="color:var(--muted)">No activity yet.</span>';
  document.getElementById('dashProjectRows').innerHTML = db.projects.map(p => {
    const prog = stageProgress(p.stage);
    const ovd  = p.end && new Date(p.end) < new Date() && p.stage !== 'Handover';
    return '<tr><td><b style="cursor:pointer;color:var(--accent)" onclick="openProjectDetail(\'' + p.id + '\')">' + p.name + '</b><br><span style="font-size:10px;color:var(--muted)">' + (p.type || '') + '</span></td><td style="font-size:11px">' + (p.client || '-') + '</td><td>' + stageBadge(p.stage) + '</td><td><div class="progress-bar" style="width:80px"><div class="progress-fill" style="width:' + prog + '%;background:var(--accent3)"></div></div><span style="font-size:10px;color:var(--muted)"> ' + prog + '%</span></td><td style="font-size:11px;color:' + (ovd ? 'var(--danger)' : '') + '">' + fmtDate(p.end) + '</td><td>' + (ovd ? '<span class="badge badge-red">OVERDUE</span>' : '<span class="badge badge-green">ON TRACK</span>') + '</td></tr>';
  }).join('') || '<tr><td colspan="6"><div class="empty">No projects yet. Click "+ New Project" to start.</div></td></tr>';
  renderSidebar();
}

function sc(label, val, color) {
  return '<div class="stat-card"><div class="stat-label">' + label + '</div><div class="stat-value"' + (color ? ' style="color:' + color + '"' : '') + '>' + val + '</div></div>';
}
function stageProgress(stage) {
  const idx = PROJECT_STAGES.indexOf(stage);
  return idx < 0 ? 0 : Math.round(((idx + 1) / PROJECT_STAGES.length) * 100);
}
function stageBadge(stage) {
  const c = { Handover:'badge-green', 'Site Installation':'badge-blue', Fabrication:'badge-blue', 'Contract Signed':'badge-yellow', Drawing:'badge-orange' };
  return '<span class="badge ' + (c[stage] || 'badge-gray') + '">' + stage + '</span>';
}
function renderSidebar() {
  document.getElementById('sidebarProjects').innerHTML = db.projects.slice(0, 8).map(p =>
    '<div class="project-chip ' + (currentProject === p.id ? 'active' : '') + '" onclick="openProjectDetail(\'' + p.id + '\')"><div class="pname">' + p.name + '</div><div class="pstage">' + p.stage + '</div><div class="progress-mini"><div class="progress-mini-fill" style="width:' + stageProgress(p.stage) + '%"></div></div></div>'
  ).join('') || '<div style="font-size:11px;color:var(--muted)">No projects yet</div>';
}

// ============================================================
// PROJECTS
// ============================================================
const STAGE_CHECKLISTS = {
  'Enquiry':['Receive enquiry','Understand scope','Visit site if needed','Log in system'],
  'Estimation':['Prepare BOQ','Calculate material quantities','Get quotations','Calculate labor costs','Prepare estimate','Get management approval'],
  'Tender Submitted':['Prepare tender document','Include specs & method statement','Submit to client','Follow up'],
  'Contract Signed':['Review contract','Get sign-off','Issue LOI/Work Order','Open project','Brief team'],
  'Drawing':['Receive architectural drawings','Prepare shop drawings','Submit for approval','Respond to comments','Get drawings approved'],
  'Material Approval':['Prepare material submittals','Submit samples','Get material approval','Place orders'],
  'Fabrication':['Issue fabrication drawings','Monitor fabrication','Quality check','Arrange delivery batches'],
  'Site Installation':['Prepare method statement','Submit RFI','Mobilize labor','Install as per drawings','Daily reporting'],
  'Snagging':['Walk site with client','List snag items','Rectify snags','Get re-inspection','Document completed snags'],
  'Handover':['Prepare as-built drawings','Prepare O&M manual','Clear invoices','Get completion certificate','Handover to client']
};

function renderProjects() {
  document.getElementById('projectDetailView').style.display = 'none';
  document.getElementById('projectListView').style.display  = 'block';
  document.getElementById('projectRows').innerHTML = db.projects.map(p =>
    '<tr><td><b style="color:var(--accent);cursor:pointer" onclick="openProjectDetail(\'' + p.id + '\')">' + p.name + '</b><br><span style="font-size:10px;color:var(--muted)">' + (p.type || '') + ' | ' + (p.location || '') + '</span></td><td style="font-size:11px">' + (p.client || '-') + '</td><td style="font-size:11px;font-family:\'DM Mono\',monospace">' + (p.value ? inr(p.value) : '-') + '</td><td>' + stageBadge(p.stage) + '</td><td><div class="progress-bar" style="width:70px"><div class="progress-fill" style="width:' + stageProgress(p.stage) + '%;background:var(--accent3)"></div></div></td><td><button class="btn btn-outline btn-sm" onclick="openProjectDetail(\'' + p.id + '\')">Open</button> <button class="btn btn-blue btn-sm" onclick="editProject(\'' + p.id + '\')">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteProject(\'' + p.id + '\')">Del</button></td></tr>'
  ).join('') || '<tr><td colspan="6"><div class="empty"><div class="empty-icon">üèóÔ∏è</div>No projects yet.</div></td></tr>';
}

function showProjectList() { currentProject = null; navigate('projects'); }

function openProjectDetail(pid) {
  currentProject = pid;
  const p = db.projects.find(pr => pr.id === pid);
  if (!p) return;
  document.getElementById('projectListView').style.display  = 'none';
  document.getElementById('projectDetailView').style.display = 'block';
  document.getElementById('view-projects').classList.add('active');
  document.getElementById('detailProjectName').textContent  = p.name;
  document.getElementById('pageTitle').textContent = p.name.toUpperCase();
  const curIdx = PROJECT_STAGES.indexOf(p.stage);
  document.getElementById('stageTimeline').innerHTML = PROJECT_STAGES.map((s, i) =>
    '<div class="stage-step"><div class="step-circle ' + (i < curIdx ? 'done' : i === curIdx ? 'active' : '') + '">' + (i < curIdx ? '‚úì' : i + 1) + '</div><div class="step-label ' + (i === curIdx ? 'active' : '') + '">' + s + '</div></div>'
  ).join('');
  const nextIdx = curIdx + 1;
  document.getElementById('stageButtons').innerHTML =
    '<span style="font-size:11px;color:var(--muted);align-self:center">Advance:</span>' +
    (nextIdx < PROJECT_STAGES.length ? '<button class="btn btn-success btn-sm" onclick="advanceStage(\'' + pid + '\')">‚Üí ' + PROJECT_STAGES[nextIdx] + '</button>' : '<span class="badge badge-green">PROJECT COMPLETE</span>') +
    (curIdx > 0 ? '<button class="btn btn-outline btn-sm" onclick="regressStage(\'' + pid + '\')">‚Üê Back</button>' : '');
  // Reset tabs to Overview
  document.querySelectorAll('.project-tab').forEach(t => t.style.display = 'none');
  document.getElementById('ptab-overview').style.display = 'block';
  document.querySelectorAll('#projectTabs .tab').forEach((t, i) => t.classList.toggle('active', i === 0));
  renderProjectTabs(p);
  renderSidebar();
}

function renderProjectTabs(p) {
  renderPtabOverview(p);
  renderPtabTasks(p);
  renderPtabRevisions(p);
  renderPtabMaterials(p);
  renderPtabDelivery(p);
  renderPtabMIR(p);
  renderPtabIssues(p);
  renderPtabTools(p);
  renderPtabLabor(p);
  renderPtabFinance(p);
  renderPtabDocs(p);
  renderPtabLog(p);
}

function ri(l, v) { return '<tr><td style="color:var(--muted);padding:4px 0;width:130px">' + l + '</td><td style="padding:4px 0">' + (v || '-') + '</td></tr>'; }

function renderPtabOverview(p) {
  if (!p.checklists) p.checklists = {};
  if (!p.checklists[p.stage]) p.checklists[p.stage] = {};
  const items = STAGE_CHECKLISTS[p.stage] || [];
  const vals = p.values || {};
  const vars = p.variations || [];
  const approvedVars = vars.filter(v => v.status === 'Approved');
  const pendingVars  = vars.filter(v => v.status === 'Pending Approval');
  const totalVar = approvedVars.reduce((s, v) => s + (v.type === 'Addition' ? +v.amount : -+v.amount), 0);
  let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">';
  html += '<div class="card"><div class="card-title">Project Info</div><table style="width:100%;font-size:13px">' + ri('Client', p.client) + ri('Type', p.type) + ri('Location', p.location) + ri('Consultant', p.consultant) + ri('Main Contractor', p.mc) + ri('Start Date', fmtDate(p.start)) + ri('Deadline', fmtDate(p.end)) + ri('Stage', p.stage) + '</table>' + (p.desc ? '<div style="margin-top:10px;font-size:12px;color:var(--muted)">' + p.desc + '</div>' : '') + '</div>';
  html += '<div class="card"><div class="card-title">Stage Checklist ‚Äî ' + p.stage + '</div>';
  items.forEach((item, i) => {
    const done = p.checklists[p.stage][i];
    html += '<div class="task-row"><div class="task-check ' + (done ? 'done' : '') + '" onclick="toggleChecklist(\'' + p.id + '\',\'' + p.stage + '\',' + i + ')">' + (done ? '‚úì' : '') + '</div><div class="task-text ' + (done ? 'done' : '') + '">' + item + '</div></div>';
  });
  html += '</div></div>';
  // Value breakdown
  html += '<div class="card" style="grid-column:1/-1"><div class="card-title">Project Value Breakdown</div><table style="width:100%;font-size:13px">';
  if (vals.estimated) html += ri('Estimated Value (Enquiry)', inr(vals.estimated));
  if (vals.quoted)    html += ri('Quoted / Tender Value', inr(vals.quoted));
  if (vals.awarded)   html += ri('Awarded / Contract Value', '<b style="color:var(--accent3)">' + inr(vals.awarded) + '</b>');
  if (vars.length) {
    html += '<tr><td colspan="2" style="padding:8px 0 4px;font-size:10px;text-transform:uppercase;color:var(--muted)">Variation Orders</td></tr>';
    vars.forEach(vo => {
      const color = vo.type === 'Addition' ? 'var(--accent3)' : 'var(--danger)';
      html += '<tr><td style="color:var(--muted);padding:3px 0">' + (vo.no || 'VO') + ' ‚Äî ' + vo.desc + '</td><td style="color:' + color + ';font-weight:700">' + (vo.type === 'Addition' ? '+' : '-') + inr(vo.amount) + ' <span class="badge ' + (vo.status === 'Approved' ? 'badge-green' : vo.status === 'Rejected' ? 'badge-red' : 'badge-yellow') + '">' + vo.status + '</span></td></tr>';
    });
    html += ri('Total Approved Variations', (totalVar >= 0 ? '+' : '') + inr(totalVar));
  }
  const finalVal = vals.revised || (vals.awarded && totalVar ? +vals.awarded + totalVar : null) || vals.awarded || vals.quoted || vals.estimated;
  if (finalVal) html += '<tr><td style="font-weight:700;padding:6px 0">Current / Revised Value</td><td style="font-weight:700;font-size:15px;color:var(--accent)">' + inr(finalVal) + '</td></tr>';
  html += '</table>';
  if (pendingVars.length) html += '<div class="alert alert-warn" style="margin-top:10px">' + pendingVars.length + ' variation(s) pending approval</div>';
  html += '<div style="margin-top:10px"><button class="btn btn-outline btn-sm" onclick="openVariationModal(\'' + p.id + '\')">+ Add Variation Order</button></div>';
  html += '</div>';
  document.getElementById('ptab-overview').innerHTML = html;
}

function toggleChecklist(pid, stage, idx) {
  const p = db.projects.find(pr => pr.id === pid);
  if (!p.checklists) p.checklists = {};
  if (!p.checklists[stage]) p.checklists[stage] = {};
  p.checklists[stage][idx] = !p.checklists[stage][idx];
  saveDB(); renderPtabOverview(p);
}

function renderPtabTasks(p) {
  const tasks = db.tasks.filter(t => t.projectId === p.id);
  document.getElementById('ptab-tasks').innerHTML =
    '<div style="margin-bottom:10px"><button class="btn btn-primary btn-sm" onclick="openModalForProject(\'addTask\',\'' + p.id + '\')">+ Add Task</button></div>' +
    '<div class="card">' + (tasks.map(t =>
      '<div class="task-row"><div class="task-check ' + (t.status === 'Done' ? 'done' : '') + '" onclick="toggleTask(\'' + t.id + '\')">' + (t.status === 'Done' ? '‚úì' : '') + '</div><div class="task-text ' + (t.status === 'Done' ? 'done' : '') + '"><b>' + t.task + '</b> <span style="font-size:10px;color:var(--muted)">‚Äî ' + (t.assign || '') + ' | Due: ' + fmtDate(t.due) + '</span>' + (t.notes ? '<div style="font-size:10px;color:var(--muted)">' + t.notes + '</div>' : '') + '</div><span class="badge ' + (t.priority === 'High' ? 'badge-red' : t.priority === 'Medium' ? 'badge-yellow' : 'badge-gray') + '">' + (t.priority || '') + '</span><button class="btn btn-blue btn-sm" onclick="editTask(\'' + t.id + '\')">Edit</button><button class="btn btn-danger btn-sm" onclick="deleteTask(\'' + t.id + '\')">‚úï</button></div>'
    ).join('') || '<div class="empty">No tasks yet.</div>') + '</div>';
}

function renderPtabRevisions(p) {
  const revs = db.revisions.filter(r => r.projectId === p.id);
  let html = '<div style="margin-bottom:10px;display:flex;gap:8px;align-items:center"><button class="btn btn-primary btn-sm" onclick="openRevisionModal(\'' + p.id + '\')">+ Add Revision / Submission</button><span style="font-size:11px;color:var(--muted)">Track Drawing Submissions, Quotation Revisions (R0, R1, R2...)</span></div>';
  html += '<div class="card"><div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Title</th><th>Type</th><th>Rev</th><th>Submitted To</th><th>By</th><th>Date</th><th>Status</th><th>Files</th></tr></thead><tbody>';
  html += revs.map(r => '<tr><td><b>' + r.title + '</b>' + (r.notes ? '<div style="font-size:10px;color:var(--muted)">' + r.notes + '</div>' : '') + '</td><td><span class="badge badge-blue">' + (r.type || '') + '</span></td><td><span class="rev-badge">' + (r.rev || '') + '</span></td><td style="font-size:11px">' + (r.to || '-') + '</td><td style="font-size:11px">' + (r.by || '-') + '</td><td style="font-size:11px">' + fmtDate(r.date) + '</td><td>' + revStatusBadge(r.status) + '</td><td>' + renderFileList(r.files) + '</td></tr>'
  ).join('') || '<tr><td colspan="8"><div class="empty">No revisions yet.</div></td></tr>';
  html += '</tbody></table></div></div>';
  document.getElementById('ptab-revisions').innerHTML = html;
}

function revStatusBadge(s) {
  const c = { Approved:'badge-green', Submitted:'badge-blue', 'Under Review':'badge-yellow', 'Rejected ‚Äì Revise & Resubmit':'badge-red', 'Approved with Comments':'badge-orange' };
  return '<span class="badge ' + (c[s] || 'badge-gray') + '">' + (s || '-') + '</span>';
}

function renderPtabMaterials(p) {
  const mats = db.materials.filter(m => m.projectId === p.id);
  let html = '<div style="margin-bottom:10px"><button class="btn btn-primary btn-sm" onclick="openModalForProject(\'addMaterial\',\'' + p.id + '\')">+ Add Material</button></div>';
  html += '<div class="card"><div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Material</th><th>Required</th><th>Ordered</th><th>Delivered</th><th>Remaining</th><th>Need By</th><th>Status</th><th>Action</th></tr></thead><tbody>';
  html += mats.map(m => {
    const del = db.batches.filter(b => b.materialId === m.id).reduce((s, b) => s + Number(b.qty), 0);
    const rem = m.qty - m.procured;
    return '<tr><td><b>' + m.name + '</b><br><span style="font-size:10px;color:var(--muted)">' + (m.supplier || '') + (m.rate ? ' | Rs.' + m.rate + '/' + m.unit : '') + '</span></td><td>' + m.qty + ' ' + m.unit + '</td><td style="color:' + (m.procured >= m.qty ? 'var(--accent3)' : 'var(--warn)') + '">' + m.procured + ' ' + m.unit + '</td><td>' + del + ' ' + m.unit + '</td><td style="color:' + (rem > 0 ? 'var(--danger)' : 'var(--accent3)') + ';font-weight:700">' + rem + ' ' + m.unit + '</td><td style="font-size:11px">' + fmtDate(m.needBy) + '</td><td><span class="badge ' + (rem > 0 ? 'badge-red' : del < m.qty ? 'badge-yellow' : 'badge-green') + '">' + (rem > 0 ? 'Short' : del < m.qty ? 'Partial' : 'Done') + '</span></td><td><button class="btn btn-blue btn-sm" onclick="openBatchModal(\'' + m.id + '\')">+Batch</button> <button class="btn btn-outline btn-sm" onclick="editMaterial(\'' + m.id + '\')">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteMaterial(\'' + m.id + '\')">‚úï</button></td></tr>';
  }).join('') || '<tr><td colspan="8"><div class="empty">No materials tracked.</div></td></tr>';
  html += '</tbody></table></div></div>';
  document.getElementById('ptab-materials').innerHTML = html;
}

function renderPtabDelivery(p) {
  const mats = db.materials.filter(m => m.projectId === p.id);
  const certs = db.certs.filter(c => c.projectId === p.id);
  let html = '<div style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-outline btn-sm" onclick="openCertModal(\'' + p.id + '\')">+ Add Test Certificate</button></div>';
  html += '<div class="card"><div class="card-title">Delivery Batches</div><div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Material</th><th>Challan No.</th><th>Qty</th><th>Date</th><th>Vehicle</th><th>Received By</th><th>Condition</th><th>Files</th></tr></thead><tbody>';
  const batches = db.batches.filter(b => mats.some(m => m.id === b.materialId));
  html += batches.map(b => {
    const m = db.materials.find(x => x.id === b.materialId);
    return '<tr><td style="font-size:11px">' + (m ? m.name : '-') + '</td><td>' + (b.no || '-') + '</td><td><b>' + b.qty + '</b> ' + (m ? m.unit : '') + '</td><td style="font-size:11px">' + fmtDate(b.date) + '</td><td style="font-size:11px">' + (b.vehicle || '-') + '</td><td style="font-size:11px">' + (b.received || '-') + '</td><td><span class="badge ' + (b.condition === 'Good' ? 'badge-green' : 'badge-red') + '">' + (b.condition || '') + '</span></td><td>' + renderFileList(b.files) + '</td></tr>';
  }).join('') || '<tr><td colspan="8"><div class="empty">No batches yet. Add via Materials tab ‚Üí +Batch button.</div></td></tr>';
  html += '</tbody></table></div></div>';
  html += '<div class="card"><div class="card-title">Test Certificates</div><div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Certificate</th><th>Material</th><th>No.</th><th>Issuer</th><th>Date</th><th>Valid Until</th><th>Status</th><th>Files</th></tr></thead><tbody>';
  html += certs.map(c => '<tr><td><b>' + c.name + '</b></td><td style="font-size:11px">' + (c.material || '-') + '</td><td style="font-size:11px">' + (c.no || '-') + '</td><td style="font-size:11px">' + (c.issuer || '-') + '</td><td style="font-size:11px">' + fmtDate(c.date) + '</td><td style="font-size:11px">' + fmtDate(c.valid) + '</td><td><span class="badge ' + (c.status === 'Approved' ? 'badge-green' : c.status === 'Expired' ? 'badge-red' : 'badge-yellow') + '">' + (c.status || '') + '</span></td><td>' + renderFileList(c.files) + '</td></tr>'
  ).join('') || '<tr><td colspan="8"><div class="empty">No certificates yet.</div></td></tr>';
  html += '</tbody></table></div></div>';
  document.getElementById('ptab-delivery').innerHTML = html;
}

function renderPtabMIR(p) {
  const mirs = db.mir.filter(m => m.projectId === p.id);
  let html = '<div style="margin-bottom:10px"><button class="btn btn-primary btn-sm" onclick="openMIRModal(\'' + p.id + '\')">+ Add MIR / WIR</button></div>';
  html += '<div class="card"><div style="overflow-x:auto"><table class="tbl"><thead><tr><th>No.</th><th>Title</th><th>Material/Work</th><th>Date</th><th>By</th><th>Result</th><th>Signature</th><th>Files</th></tr></thead><tbody>';
  html += mirs.map(m => '<tr><td style="font-size:11px">' + (m.no || '-') + '</td><td><b>' + m.title + '</b>' + (m.notes ? '<div style="font-size:10px;color:var(--muted)">' + m.notes.substring(0, 60) + '</div>' : '') + '</td><td style="font-size:11px">' + (m.material || '-') + '</td><td style="font-size:11px">' + fmtDate(m.date) + '</td><td style="font-size:11px">' + (m.by || '-') + '</td><td><span class="badge ' + (m.result === 'Pass' ? 'badge-green' : m.result === 'Fail ‚Äì Rejected' ? 'badge-red' : 'badge-yellow') + '">' + (m.result || '') + '</span></td><td><span class="badge ' + (m.sigStatus === 'Signed ‚Äì Approved' ? 'badge-green' : m.sigStatus === 'Pending Signature' ? 'badge-yellow' : 'badge-red') + '">' + (m.sigStatus || '') + '</span>' + (m.sigStatus !== 'Signed ‚Äì Approved' ? ' <button class="btn btn-success btn-sm" onclick="markMIRSigned(\'' + m.id + '\')">Sign</button>' : '') + '</td><td>' + renderFileList(m.files) + '</td></tr>'
  ).join('') || '<tr><td colspan="8"><div class="empty">No MIR/WIR records yet.</div></td></tr>';
  html += '</tbody></table></div></div>';
  document.getElementById('ptab-mir').innerHTML = html;
}

function renderPtabIssues(p) {
  const issues = db.issues.filter(i => i.projectId === p.id);
  let html = '<div style="margin-bottom:10px"><button class="btn btn-primary btn-sm" onclick="openModalForProject(\'addIssue\',\'' + p.id + '\')">+ Raise Issue</button></div>';
  html += '<div class="card"><table class="tbl"><thead><tr><th>Issue</th><th>Severity</th><th>Raised By</th><th>Date</th><th>Assigned</th><th>Status</th><th>Files</th><th>Action</th></tr></thead><tbody>';
  html += issues.map(i => '<tr><td><b>' + i.title + '</b>' + (i.desc ? '<div style="font-size:10px;color:var(--muted)">' + i.desc.substring(0, 60) + '</div>' : '') + '</td><td><span class="badge ' + (i.severity === 'Critical' ? 'badge-red' : i.severity === 'High' ? 'badge-orange' : i.severity === 'Medium' ? 'badge-yellow' : 'badge-gray') + '">' + (i.severity || '') + '</span></td><td style="font-size:11px">' + (i.by || '-') + '</td><td style="font-size:11px">' + fmtDate(i.date) + '</td><td style="font-size:11px">' + (i.assign || '-') + '</td><td><span class="badge ' + (i.status === 'Resolved' ? 'badge-green' : i.status === 'In Progress' ? 'badge-blue' : 'badge-red') + '">' + (i.status || 'Open') + '</span></td><td>' + renderFileList(i.files) + '</td><td><button class="btn btn-blue btn-sm" onclick="editIssue(\'' + i.id + '\')">Edit</button>' + (i.status !== 'Resolved' ? ' <button class="btn btn-success btn-sm" onclick="resolveIssue(\'' + i.id + '\')">Resolve</button>' : '') + ' <button class="btn btn-danger btn-sm" onclick="deleteIssue(\'' + i.id + '\')">‚úï</button></td></tr>'
  ).join('') || '<tr><td colspan="8"><div class="empty">No issues raised.</div></td></tr>';
  html += '</tbody></table></div>';
  document.getElementById('ptab-issues').innerHTML = html;
}

function renderPtabTools(p) {
  const tools = db.tools.filter(t => t.projectId === p.id);
  let html = '<div style="margin-bottom:10px"><button class="btn btn-primary btn-sm" onclick="openModalForProject(\'addTool\',\'' + p.id + '\')">+ Add Tool</button></div>';
  html += '<div class="card"><table class="tbl"><thead><tr><th>Tool</th><th>Req</th><th>Mob.</th><th>Shortfall</th><th>Need By</th><th>Status</th><th>Action</th></tr></thead><tbody>';
  html += tools.map(t => { const s = t.qty - t.avail; return '<tr><td><b>' + t.name + '</b></td><td>' + t.qty + '</td><td>' + t.avail + '</td><td style="color:' + (s > 0 ? 'var(--danger)' : 'var(--accent3)') + ';font-weight:700">' + s + '</td><td style="font-size:11px">' + fmtDate(t.needBy) + '</td><td><span class="badge ' + (s > 0 ? 'badge-red' : 'badge-green') + '">' + (s > 0 ? 'Short' : 'Ready') + '</span></td><td><button class="btn btn-danger btn-sm" onclick="deleteTool(\'' + t.id + '\')">‚úï</button></td></tr>'; }).join('') || '<tr><td colspan="7"><div class="empty">No tools tracked.</div></td></tr>';
  html += '</tbody></table></div>';
  document.getElementById('ptab-tools').innerHTML = html;
}

function renderPtabLabor(p) {
  const labors = db.labor.filter(l => l.projectId === p.id);
  let html = '<div style="margin-bottom:10px"><button class="btn btn-primary btn-sm" onclick="openModalForProject(\'addLabor\',\'' + p.id + '\')">+ Add Labor</button></div>';
  html += '<div class="card"><table class="tbl"><thead><tr><th>Trade</th><th>Req</th><th>Dep.</th><th>Shortfall</th><th>Mob. Date</th><th>Status</th><th>Action</th></tr></thead><tbody>';
  html += labors.map(l => { const s = l.req - l.dep; return '<tr><td><b>' + l.trade + '</b></td><td>' + l.req + '</td><td>' + l.dep + '</td><td style="color:' + (s > 0 ? 'var(--danger)' : 'var(--accent3)') + ';font-weight:700">' + s + '</td><td style="font-size:11px">' + fmtDate(l.mobDate) + '</td><td><span class="badge ' + (s > 0 ? 'badge-red' : 'badge-green') + '">' + (s > 0 ? 'Short' : 'OK') + '</span></td><td><button class="btn btn-danger btn-sm" onclick="deleteLabor(\'' + l.id + '\')">‚úï</button></td></tr>'; }).join('') || '<tr><td colspan="7"><div class="empty">No labor tracked.</div></td></tr>';
  html += '</tbody></table></div>';
  document.getElementById('ptab-labor').innerHTML = html;
}

function renderPtabFinance(p) {
  const entries = db.finance.filter(f => f.projectId === p.id);
  const income  = entries.filter(f => ['Invoice to Client','Payment from Client'].includes(f.type)).reduce((s, f) => s + Number(f.amount), 0);
  const expense = entries.filter(f => !['Invoice to Client','Payment from Client'].includes(f.type)).reduce((s, f) => s + Number(f.amount), 0);
  let html = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">' + sc('Contract Value', inr(p.value || 0), 'var(--accent)') + sc('Income', inr(income), 'var(--accent3)') + sc('Expenses', inr(expense), 'var(--danger)') + '</div>';
  html += '<div style="margin-bottom:10px"><button class="btn btn-primary btn-sm" onclick="openModalForProject(\'addFinance\',\'' + p.id + '\')">+ Add Entry</button></div>';
  html += '<div class="card"><table class="tbl"><thead><tr><th>Type</th><th>Description</th><th>Amount</th><th>Date</th><th>Status</th><th>Action</th></tr></thead><tbody>';
  html += entries.map(f => '<tr><td><span class="badge badge-gray">' + f.type + '</span></td><td>' + (f.desc || '-') + '</td><td style="font-family:\'DM Mono\',monospace;font-size:11px">' + inr(f.amount) + '</td><td style="font-size:11px">' + fmtDate(f.date) + '</td><td><span class="badge ' + (f.status === 'Paid' || f.status === 'Received' ? 'badge-green' : f.status === 'Overdue' ? 'badge-red' : 'badge-yellow') + '">' + f.status + '</span></td><td><button class="btn btn-danger btn-sm" onclick="deleteFinance(\'' + f.id + '\')">‚úï</button></td></tr>'
  ).join('') || '<tr><td colspan="6"><div class="empty">No finance entries.</div></td></tr>';
  html += '</tbody></table></div>';
  document.getElementById('ptab-finance').innerHTML = html;
}

function renderPtabDocs(p) {
  const docs = db.documents.filter(d => d.projectId === p.id);
  let html = '<div style="margin-bottom:10px"><button class="btn btn-primary btn-sm" onclick="openModalForProject(\'addDocument\',\'' + p.id + '\')">+ Add Document</button></div>';
  html += '<div class="card"><table class="tbl"><thead><tr><th>Name</th><th>Type</th><th>By</th><th>Date</th><th>Status</th><th>Files</th></tr></thead><tbody>';
  html += docs.map(d => '<tr><td><b>' + d.name + '</b></td><td><span class="badge badge-blue">' + (d.type || '') + '</span></td><td style="font-size:11px">' + (d.by || '-') + '</td><td style="font-size:11px">' + fmtDate(d.date) + '</td><td><span class="badge ' + (d.status === 'Approved' ? 'badge-green' : d.status === 'Rejected' ? 'badge-red' : 'badge-yellow') + '">' + (d.status || '') + '</span></td><td>' + renderFileList(d.files) + '</td></tr>'
  ).join('') || '<tr><td colspan="6"><div class="empty">No documents added.</div></td></tr>';
  html += '</tbody></table></div>';
  document.getElementById('ptab-docs').innerHTML = html;
}

function renderPtabLog(p) {
  const logs = db.logs.filter(l => l.projectId === p.id).sort((a, b) => (b.date || '').localeCompare(a.date || ''));
  let html = '<div style="margin-bottom:10px"><button class="btn btn-primary btn-sm" onclick="openLogModal(\'' + p.id + '\')">+ Add Daily Log</button></div>';
  html += logs.map(l =>
    '<div class="card" style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px"><b>' + fmtDate(l.date) + '</b><div><span class="badge badge-gray">' + (l.weather || '') + '</span> <span class="badge badge-blue">' + (l.workers || 0) + ' workers</span></div></div>' +
    (l.work ? '<div style="margin-bottom:5px;font-size:12px"><b style="font-size:10px;color:var(--muted)">WORK DONE: </b>' + l.work + '</div>' : '') +
    (l.issues ? '<div class="alert alert-warn">' + l.issues + '</div>' : '') +
    (l.instructions ? '<div style="font-size:11px;color:var(--muted)">Instructions: ' + l.instructions + '</div>' : '') +
    renderFileList(l.files) + '</div>'
  ).join('') || '<div class="empty"><div class="empty-icon">üìã</div>No daily logs yet.</div>';
  document.getElementById('ptab-log').innerHTML = html;
}

// ============================================================
// GLOBAL VIEWS
// ============================================================
function renderTasks() {
  document.getElementById('taskFilterChips').innerHTML =
    '<div class="chip active" onclick="filterTasks(this,\'all\')">All</div><div class="chip" onclick="filterTasks(this,\'pending\')">Pending</div><div class="chip" onclick="filterTasks(this,\'done\')">Done</div><div class="chip" onclick="filterTasks(this,\'overdue\')">Overdue</div>';
  renderTaskTable(db.tasks);
}
function filterTasks(el, f) {
  document.querySelectorAll('#taskFilterChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  let t = db.tasks;
  if (f === 'pending') t = t.filter(x => x.status !== 'Done');
  if (f === 'done')    t = t.filter(x => x.status === 'Done');
  if (f === 'overdue') t = t.filter(x => x.status !== 'Done' && x.due && new Date(x.due) < new Date());
  renderTaskTable(t);
}
function renderTaskTable(tasks) {
  document.getElementById('taskRows').innerHTML = tasks.map(t => {
    const p = db.projects.find(pr => pr.id === t.projectId);
    const ovd = t.status !== 'Done' && t.due && new Date(t.due) < new Date();
    return '<tr><td><b>' + t.task + '</b>' + (t.notes ? '<div style="font-size:10px;color:var(--muted)">' + t.notes + '</div>' : '') + '</td><td style="font-size:11px">' + (p ? p.name : '-') + '</td><td style="font-size:11px">' + (t.assign || '-') + '</td><td style="color:' + (ovd ? 'var(--danger)' : '') + ';font-size:11px">' + fmtDate(t.due) + (ovd ? ' (OVERDUE)' : '') + '</td><td><span class="badge ' + (t.priority === 'High' ? 'badge-red' : t.priority === 'Medium' ? 'badge-yellow' : 'badge-gray') + '">' + (t.priority || '') + '</span></td><td><span class="badge ' + (t.status === 'Done' ? 'badge-green' : 'badge-yellow') + '">' + (t.status || 'Pending') + '</span></td><td><button class="btn btn-success btn-sm" onclick="toggleTask(\'' + t.id + '\')">' + (t.status === 'Done' ? 'Undo' : 'Done') + '</button> <button class="btn btn-blue btn-sm" onclick="editTask(\'' + t.id + '\')">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteTask(\'' + t.id + '\')">‚úï</button></td></tr>';
  }).join('') || '<tr><td colspan="7"><div class="empty">No tasks found.</div></td></tr>';
}

function renderIssuesView() {
  document.getElementById('issueRows').innerHTML = db.issues.map(i => {
    const p = db.projects.find(pr => pr.id === i.projectId);
    return '<tr><td><b>' + i.title + '</b></td><td style="font-size:11px">' + (p ? p.name : '-') + '</td><td><span class="badge ' + (i.severity === 'Critical' ? 'badge-red' : i.severity === 'High' ? 'badge-orange' : i.severity === 'Medium' ? 'badge-yellow' : 'badge-gray') + '">' + (i.severity || '') + '</span></td><td style="font-size:11px">' + (i.by || '-') + '</td><td style="font-size:11px">' + fmtDate(i.date) + '</td><td><span class="badge ' + (i.status === 'Resolved' ? 'badge-green' : i.status === 'In Progress' ? 'badge-blue' : 'badge-red') + '">' + (i.status || 'Open') + '</span></td><td><button class="btn btn-blue btn-sm" onclick="editIssue(\'' + i.id + '\')">Edit</button>' + (i.status !== 'Resolved' ? ' <button class="btn btn-success btn-sm" onclick="resolveIssue(\'' + i.id + '\')">Resolve</button>' : '') + ' <button class="btn btn-danger btn-sm" onclick="deleteIssue(\'' + i.id + '\')">‚úï</button></td></tr>';
  }).join('') || '<tr><td colspan="7"><div class="empty"><div class="empty-icon">‚ö†Ô∏è</div>No issues raised.</div></td></tr>';
}

function renderMaterialsView() {
  document.getElementById('materialRows').innerHTML = db.materials.map(m => {
    const p = db.projects.find(pr => pr.id === m.projectId);
    const del = db.batches.filter(b => b.materialId === m.id).reduce((s, b) => s + Number(b.qty), 0);
    const bct = db.batches.filter(b => b.materialId === m.id).length;
    const rem = m.qty - m.procured;
    return '<tr><td><b>' + m.name + '</b><br><span style="font-size:10px;color:var(--muted)">' + (m.supplier || '') + '</span></td><td style="font-size:11px">' + (p ? p.name : '-') + '</td><td>' + m.qty + ' ' + m.unit + '</td><td style="color:' + (m.procured >= m.qty ? 'var(--accent3)' : 'var(--warn)') + '">' + m.procured + ' ' + m.unit + '</td><td>' + del + ' ' + m.unit + '</td><td style="color:' + (rem > 0 ? 'var(--danger)' : 'var(--accent3)') + ';font-weight:700">' + rem + ' ' + m.unit + '</td><td><span class="badge badge-blue">' + bct + ' batches</span></td><td style="font-size:11px">' + fmtDate(m.needBy) + '</td><td><span class="badge ' + (rem > 0 ? 'badge-red' : del < m.qty ? 'badge-yellow' : 'badge-green') + '">' + (rem > 0 ? 'Short' : del < m.qty ? 'Partial' : 'Done') + '</span></td><td><button class="btn btn-blue btn-sm" onclick="openBatchModal(\'' + m.id + '\')">+Batch</button> <button class="btn btn-outline btn-sm" onclick="editMaterial(\'' + m.id + '\')">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteMaterial(\'' + m.id + '\')">‚úï</button></td></tr>';
  }).join('') || '<tr><td colspan="10"><div class="empty"><div class="empty-icon">üì¶</div>No materials tracked.</div></td></tr>';
}

function renderToolsView() {
  document.getElementById('toolRows').innerHTML = db.tools.map(t => {
    const p = db.projects.find(pr => pr.id === t.projectId);
    const s = t.qty - t.avail;
    return '<tr><td><b>' + t.name + '</b></td><td style="font-size:11px">' + (p ? p.name : '-') + '</td><td>' + t.qty + '</td><td>' + t.avail + '</td><td style="color:' + (s > 0 ? 'var(--danger)' : 'var(--accent3)') + ';font-weight:700">' + s + '</td><td style="font-size:11px">' + fmtDate(t.needBy) + '</td><td><span class="badge ' + (s > 0 ? 'badge-red' : 'badge-green') + '">' + (s > 0 ? 'Short' : 'Ready') + '</span></td><td><button class="btn btn-danger btn-sm" onclick="deleteTool(\'' + t.id + '\')">‚úï</button></td></tr>';
  }).join('') || '<tr><td colspan="8"><div class="empty">No tools tracked.</div></td></tr>';
}

function renderLaborView() {
  document.getElementById('laborRows').innerHTML = db.labor.map(l => {
    const p = db.projects.find(pr => pr.id === l.projectId);
    const s = l.req - l.dep;
    return '<tr><td><b>' + l.trade + '</b></td><td style="font-size:11px">' + (p ? p.name : '-') + '</td><td>' + l.req + '</td><td>' + l.dep + '</td><td style="color:' + (s > 0 ? 'var(--danger)' : 'var(--accent3)') + ';font-weight:700">' + s + '</td><td style="font-size:11px">' + fmtDate(l.mobDate) + '</td><td><span class="badge ' + (s > 0 ? 'badge-red' : 'badge-green') + '">' + (s > 0 ? 'Short' : 'OK') + '</span></td><td><button class="btn btn-danger btn-sm" onclick="deleteLabor(\'' + l.id + '\')">‚úï</button></td></tr>';
  }).join('') || '<tr><td colspan="8"><div class="empty">No labor tracked.</div></td></tr>';
}

function renderFinanceView() {
  const inc  = db.finance.filter(f => ['Payment from Client','Invoice to Client'].includes(f.type) && f.status !== 'Pending').reduce((s, f) => s + Number(f.amount), 0);
  const exp  = db.finance.filter(f => !['Invoice to Client','Payment from Client'].includes(f.type)).reduce((s, f) => s + Number(f.amount), 0);
  const pend = db.finance.filter(f => f.status === 'Pending' || f.status === 'Overdue').reduce((s, f) => s + Number(f.amount), 0);
  document.getElementById('finStats').innerHTML = sc('Total Received', inr(inc), 'var(--accent3)') + sc('Total Expenses', inr(exp), 'var(--danger)') + sc('Pending', inr(pend), 'var(--warn)') + sc('Net', inr(inc - exp), inc - exp >= 0 ? 'var(--accent3)' : 'var(--danger)');
  document.getElementById('finRows').innerHTML = db.finance.map(f => {
    const p = db.projects.find(pr => pr.id === f.projectId);
    return '<tr><td style="font-size:11px">' + (p ? p.name : '-') + '</td><td><span class="badge badge-gray">' + f.type + '</span></td><td style="font-size:11px">' + (f.desc || '-') + '</td><td style="font-family:\'DM Mono\',monospace;font-size:11px">' + inr(f.amount) + '</td><td style="font-size:11px">' + fmtDate(f.date) + '</td><td><span class="badge ' + (f.status === 'Paid' || f.status === 'Received' ? 'badge-green' : f.status === 'Overdue' ? 'badge-red' : 'badge-yellow') + '">' + f.status + '</span></td></tr>';
  }).join('') || '<tr><td colspan="6"><div class="empty">No finance entries.</div></td></tr>';
}

function renderDocumentsView() {
  document.getElementById('docRows').innerHTML = db.documents.map(d => {
    const p = db.projects.find(pr => pr.id === d.projectId);
    return '<tr><td><b>' + d.name + '</b></td><td style="font-size:11px">' + (p ? p.name : '-') + '</td><td><span class="badge badge-blue">' + (d.type || '') + '</span></td><td style="font-size:11px">' + (d.by || '-') + '</td><td style="font-size:11px">' + fmtDate(d.date) + '</td><td><span class="badge ' + (d.status === 'Approved' ? 'badge-green' : d.status === 'Rejected' ? 'badge-red' : 'badge-yellow') + '">' + (d.status || '') + '</span></td><td>' + renderFileList(d.files) + '</td></tr>';
  }).join('') || '<tr><td colspan="7"><div class="empty">No documents.</div></td></tr>';
}

function renderTeamView() {
  const el = document.getElementById('teamList');
  if (!el) return;
  el.innerHTML = db.team.length
    ? '<table class="tbl"><thead><tr><th>Name</th><th>Role</th><th>WhatsApp</th><th>Action</th></tr></thead><tbody>' +
      db.team.map(t => '<tr><td><b>' + t.name + '</b></td><td><span class="badge badge-blue">' + t.role + '</span></td><td style="font-family:\'DM Mono\',monospace;font-size:11px">+' + t.phone + '</td><td><button class="btn btn-wa btn-sm" onclick="sendWATest(\'' + t.id + '\')">Test</button> <button class="btn btn-danger btn-sm" onclick="deleteTeamMember(\'' + t.id + '\')">‚úï</button></td></tr>').join('') +
      '</tbody></table>'
    : '<div style="color:var(--muted);font-size:12px;padding:10px 0">No team members yet.</div>';
}

// ============================================================
// REPORTS ‚Äî Excel & PDF with Custom Date Range
// ============================================================
function renderReports() {
  const sel = document.getElementById('rpt-project');
  if (sel) {
    sel.innerHTML = '<option value="all">All Projects</option>' +
      db.projects.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
  }
  // Default date range: last 6 months
  const toEl = document.getElementById('rpt-to');
  const frEl = document.getElementById('rpt-from');
  if (toEl && !toEl.value) toEl.value = new Date().toISOString().split('T')[0];
  if (frEl && !frEl.value) {
    const d = new Date(); d.setMonth(d.getMonth() - 6);
    frEl.value = d.toISOString().split('T')[0];
  }
  document.getElementById('reportCards').innerHTML = db.projects.map(p => {
    const tasks = db.tasks.filter(t => t.projectId === p.id);
    const done  = tasks.filter(t => t.status === 'Done').length;
    const oi    = db.issues.filter(i => i.projectId === p.id && i.status !== 'Resolved').length;
    const ms    = db.materials.filter(m => m.projectId === p.id && m.procured < m.qty).length;
    const pm    = db.mir.filter(m => m.projectId === p.id && m.sigStatus === 'Pending Signature').length;
    return '<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><b style="font-family:\'Bebas Neue\',sans-serif;font-size:16px">' + p.name + '</b>' + stageBadge(p.stage) + '</div><div class="progress-bar" style="margin-bottom:6px"><div class="progress-fill" style="width:' + stageProgress(p.stage) + '%;background:var(--accent3)"></div></div><div style="font-size:11px;color:var(--muted);margin-bottom:8px">' + p.stage + ' ‚Äî ' + stageProgress(p.stage) + '% | ' + (p.value ? inr(p.value) : '') + '</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;font-size:11px"><div>Tasks: ' + done + '/' + tasks.length + ' done</div><div>Issues: ' + (oi > 0 ? '<span style="color:var(--danger)">' + oi + ' open</span>' : 'OK') + '</div><div>Mat Short: ' + (ms > 0 ? '<span style="color:var(--danger)">' + ms + '</span>' : 'OK') + '</div><div>MIR Pending: ' + (pm > 0 ? '<span style="color:var(--warn)">' + pm + '</span>' : 'OK') + '</div></div><div style="margin-top:10px"><button class="btn btn-outline btn-sm" onclick="openProjectDetail(\'' + p.id + '\')">Open Project</button> <button class="btn btn-blue btn-sm" onclick="quickProjReport(\'' + p.id + '\')">Quick PDF</button></div></div>';
  }).join('') || '<div class="empty" style="grid-column:1/-1">No projects yet.</div>';
}

function getReportData() {
  const type    = gv('rpt-type');
  const pid     = gv('rpt-project');
  const fromVal = gv('rpt-from');
  const toVal   = gv('rpt-to');
  const fromD   = fromVal ? new Date(fromVal + 'T00:00:00') : null;
  const toD     = toVal   ? new Date(toVal   + 'T23:59:59') : null;
  const projName = pid === 'all' ? 'All Projects' : (db.projects.find(p => p.id === pid) || {}).name || '';

  function fP(arr) { return pid === 'all' ? arr : arr.filter(x => x.projectId === pid); }
  function fD(arr, field) {
    return arr.filter(x => {
      if (!x[field]) return true;
      const d = new Date(x[field]);
      if (fromD && d < fromD) return false;
      if (toD   && d > toD)   return false;
      return true;
    });
  }
  const matIds = new Set(fP(db.materials).map(m => m.id));
  const sheets = {};

  if (type === 'project' || type === 'full') {
    const rows = pid === 'all' ? db.projects : db.projects.filter(p => p.id === pid);
    sheets['Projects Summary'] = {
      headers: ['Project','Client','Type','Stage','Progress','Start','Deadline','Consultant','Main Contractor','Estimated (Rs.)','Quoted (Rs.)','Awarded (Rs.)','Revised (Rs.)'],
      rows: rows.map(p => {
        const v = p.values || {};
        return [p.name, p.client||'', p.type||'', p.stage, stageProgress(p.stage)+'%', fmtDate(p.start), fmtDate(p.end), p.consultant||'', p.mc||'', v.estimated||'', v.quoted||'', v.awarded||'', v.revised||''];
      })
    };
  }
  if (type === 'tasks' || type === 'full') {
    const rows = fD(fP(db.tasks), 'due');
    sheets['Tasks'] = {
      headers: ['Task','Project','Assigned To','Due Date','Priority','Status','Notes'],
      rows: rows.map(t => { const p = db.projects.find(pr => pr.id === t.projectId); return [t.task, p?p.name:'', t.assign||'', fmtDate(t.due), t.priority||'', t.status||'Pending', t.notes||'']; })
    };
  }
  if (type === 'issues' || type === 'full') {
    const rows = fD(fP(db.issues), 'date');
    sheets['Issues'] = {
      headers: ['Title','Project','Severity','Category','Raised By','Date','Assigned To','Target Date','Status'],
      rows: rows.map(i => { const p = db.projects.find(pr => pr.id === i.projectId); return [i.title, p?p.name:'', i.severity||'', i.cat||'', i.by||'', fmtDate(i.date), i.assign||'', fmtDate(i.target), i.status||'Open']; })
    };
  }
  if (type === 'materials' || type === 'full') {
    const rows = fP(db.materials);
    sheets['Materials'] = {
      headers: ['Material','Project','Unit','Required','Ordered','Delivered','Remaining','Need By','Supplier','Rate'],
      rows: rows.map(m => {
        const p = db.projects.find(pr => pr.id === m.projectId);
        const del = db.batches.filter(b => b.materialId === m.id).reduce((s, b) => s + Number(b.qty), 0);
        return [m.name, p?p.name:'', m.unit||'', m.qty||0, m.procured||0, del, (m.qty - m.procured)||0, fmtDate(m.needBy), m.supplier||'', m.rate||0];
      })
    };
  }
  if (type === 'delivery' || type === 'full') {
    const rows = fD(db.batches.filter(b => matIds.has(b.materialId)), 'date');
    sheets['Delivery Batches'] = {
      headers: ['Material','Project','Challan No.','Qty','Date','Vehicle/Transport','Received By','Condition','Remarks'],
      rows: rows.map(b => {
        const m = db.materials.find(x => x.id === b.materialId);
        const p = m ? db.projects.find(pr => pr.id === m.projectId) : null;
        return [m?m.name:'', p?p.name:'', b.no||'', b.qty||0, fmtDate(b.date), b.vehicle||'', b.received||'', b.condition||'', b.remarks||''];
      })
    };
  }
  if (type === 'labor' || type === 'full') {
    const rows = fD(fP(db.labor), 'mobDate');
    sheets['Labor'] = {
      headers: ['Trade/Role','Project','Required','Deployed','Shortfall','Mob. Date','Source','Remarks'],
      rows: rows.map(l => { const p = db.projects.find(pr => pr.id === l.projectId); return [l.trade, p?p.name:'', l.req||0, l.dep||0, (l.req-l.dep)||0, fmtDate(l.mobDate), l.source||'', l.remarks||'']; })
    };
  }
  if (type === 'tools' || type === 'full') {
    const rows = fD(fP(db.tools), 'needBy');
    sheets['Tools & Equipment'] = {
      headers: ['Tool/Equipment','Project','Required','Mobilized','Shortfall','Need By','Source','Remarks'],
      rows: rows.map(t => { const p = db.projects.find(pr => pr.id === t.projectId); return [t.name, p?p.name:'', t.qty||0, t.avail||0, (t.qty-t.avail)||0, fmtDate(t.needBy), t.source||'', t.remarks||'']; })
    };
  }
  if (type === 'finance' || type === 'full') {
    const rows = fD(fP(db.finance), 'date');
    const inc = rows.filter(f => ['Invoice to Client','Payment from Client'].includes(f.type)).reduce((s, f) => s + Number(f.amount||0), 0);
    const exp = rows.filter(f => !['Invoice to Client','Payment from Client'].includes(f.type)).reduce((s, f) => s + Number(f.amount||0), 0);
    sheets['Finance'] = {
      headers: ['Project','Type','Description','Amount (Rs.)','Date','Status'],
      rows: rows.map(f => { const p = db.projects.find(pr => pr.id === f.projectId); return [p?p.name:'', f.type||'', f.desc||'', Number(f.amount||0).toLocaleString('en-IN'), fmtDate(f.date), f.status||'']; }),
      summary: 'Income: Rs.' + inc.toLocaleString('en-IN') + '  |  Expenses: Rs.' + exp.toLocaleString('en-IN') + '  |  Net: Rs.' + (inc - exp).toLocaleString('en-IN')
    };
  }
  if (type === 'documents' || type === 'full') {
    const rows = fD(fP(db.documents), 'date');
    sheets['Documents Register'] = {
      headers: ['Document Name','Project','Type','Submitted By','Date','Status','Notes'],
      rows: rows.map(d => { const p = db.projects.find(pr => pr.id === d.projectId); return [d.name, p?p.name:'', d.type||'', d.by||'', fmtDate(d.date), d.status||'', d.notes||'']; })
    };
  }
  if (type === 'mir' || type === 'full') {
    const rows = fD(fP(db.mir), 'date');
    sheets['MIR / WIR Register'] = {
      headers: ['Report No.','Title','Project','Material/Work','Date','Inspected By','Client Rep','Result','Signature Status'],
      rows: rows.map(m => { const p = db.projects.find(pr => pr.id === m.projectId); return [m.no||'', m.title, p?p.name:'', m.material||'', fmtDate(m.date), m.by||'', m.clientRep||'', m.result||'', m.sigStatus||'']; })
    };
  }
  if (type === 'site' || type === 'full') {
    const rows = fD(fP(db.logs), 'date');
    sheets['Site Daily Log'] = {
      headers: ['Date','Project','Weather','Workers','Progress%','Work Done','Issues','Instructions'],
      rows: rows.map(l => { const p = db.projects.find(pr => pr.id === l.projectId); return [fmtDate(l.date), p?p.name:'', l.weather||'', l.workers||0, (l.prog||0)+'%', l.work||'', l.issues||'', l.instructions||'']; })
    };
  }
  return { sheets, projName, type, fromStr: fromVal ? fmtDate(fromVal) : 'All dates', toStr: toVal ? fmtDate(toVal) : 'Present' };
}

function generateReport(format) {
  const data = getReportData();
  const total = Object.values(data.sheets).reduce((s, sh) => s + sh.rows.length, 0);
  if (total === 0) {
    alert('No data found for selected filters.\n\nTips:\n- Try selecting "All Projects"\n- Clear the date range or widen it\n- Choose a different report type');
    return;
  }
  if (format === 'excel') generateExcel(data);
  else generatePDF(data);
}

function generateExcel({ sheets, projName, type, fromStr, toStr }) {
  let csv = '"FacadeOps Report ‚Äî ' + type.toUpperCase() + '"\r\n';
  csv += '"Project:","' + projName + '","Period:","' + fromStr + ' to ' + toStr + '","Generated:","' + new Date().toLocaleString('en-IN') + '"\r\n\r\n';
  Object.entries(sheets).forEach(([name, sh]) => {
    csv += '"=== ' + name.toUpperCase() + ' ==="\r\n';
    if (sh.summary) csv += '"' + sh.summary + '"\r\n';
    csv += sh.headers.map(h => '"' + h + '"').join(',') + '\r\n';
    if (!sh.rows.length) { csv += '"No records for this filter"\r\n\r\n'; return; }
    sh.rows.forEach(row => {
      csv += row.map(c => '"' + String(c == null ? '' : c).replace(/"/g, '""') + '"').join(',') + '\r\n';
    });
    csv += '"Total: ' + sh.rows.length + ' records"\r\n\r\n';
  });
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'FacadeOps_' + type + '_' + projName.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 25) + '_' + new Date().toISOString().split('T')[0] + '.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
  alert('Excel/CSV downloaded! Open in Microsoft Excel or Google Sheets.');
}

function generatePDF({ sheets, projName, type, fromStr, toStr }) {
  const win = window.open('', '_blank');
  if (!win) { alert('Popup blocked! Please allow popups for this site.'); return; }
  let body = '';
  Object.entries(sheets).forEach(([name, sh]) => {
    body += '<h3>' + name + '</h3>';
    if (sh.summary) body += '<p class="sum">' + sh.summary + '</p>';
    if (!sh.rows.length) { body += '<p class="empty">No records for selected filters.</p>'; return; }
    body += '<div class="tw"><table><thead><tr>' + sh.headers.map(h => '<th>' + h + '</th>').join('') + '</tr></thead><tbody>';
    sh.rows.forEach((row, i) => {
      body += '<tr class="' + (i % 2 ? 'alt' : '') + '">' + row.map(c => '<td>' + (c == null ? '' : c) + '</td>').join('') + '</tr>';
    });
    body += '</tbody></table></div><p class="cnt">Total: ' + sh.rows.length + ' records</p>';
  });
  win.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>FacadeOps Report</title><style>@page{size:A4 landscape;margin:1.2cm}*{box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:10px;color:#1a1a1a;margin:0}.hdr{background:#0d0f14;color:#f0a500;padding:10px 14px;border-radius:6px;margin-bottom:10px}.hdr h1{font-size:18px;margin:0 0 2px;letter-spacing:2px}.hdr .meta{font-size:10px;color:#aaa}h3{font-size:12px;font-weight:700;color:#f0a500;border-bottom:2px solid #f0a500;padding-bottom:3px;margin:16px 0 6px;text-transform:uppercase;letter-spacing:1px}.sum{background:#fff8e1;border:1px solid #f0a500;border-radius:4px;padding:5px 10px;font-size:10px;font-weight:700;color:#8a5c00;margin-bottom:6px}.tw{overflow:visible}table{width:100%;border-collapse:collapse;margin-bottom:4px;font-size:9px}th{background:#0d0f14;color:#f0a500;padding:4px 6px;text-align:left;font-size:8px;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}td{padding:3px 6px;border-bottom:1px solid #e5e7eb;vertical-align:top;word-break:break-word}tr.alt td{background:#f9fafb}.cnt{font-size:9px;color:#6b7280;margin-bottom:4px}.empty{font-size:10px;color:#9ca3af;font-style:italic;padding:6px}@media print{h3{page-break-before:auto}}</style></head><body>');
  win.document.write('<div class="hdr"><h1>FacadeOps ‚Äî ' + type.toUpperCase() + ' REPORT</h1><div class="meta">Project: <b>' + projName + '</b> &nbsp;|&nbsp; Period: <b>' + fromStr + '</b> to <b>' + toStr + '</b> &nbsp;|&nbsp; Generated: <b>' + new Date().toLocaleString('en-IN') + '</b> &nbsp;|&nbsp; FacadeOps Project Management</div></div>');
  win.document.write(body);
  win.document.write('</body></html>');
  win.document.close();
  setTimeout(() => { win.focus(); win.print(); }, 600);
}

function previewReport() {
  const data = getReportData();
  const area = document.getElementById('reportPreviewArea');
  let html = '<div class="card" style="margin-top:14px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div class="card-title" style="margin:0">PREVIEW ‚Äî ' + data.type.toUpperCase() + ' | ' + data.projName + ' | ' + data.fromStr + ' to ' + data.toStr + '</div><button class="btn btn-danger btn-sm" onclick="document.getElementById(\'reportPreviewArea\').innerHTML=\'\'">Close</button></div>';
  Object.entries(data.sheets).forEach(([name, sh]) => {
    html += '<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;margin-bottom:6px">' + name + ' (' + sh.rows.length + ' records)</div>';
    if (sh.summary) html += '<div class="alert alert-warn" style="margin-bottom:8px">' + sh.summary + '</div>';
    if (!sh.rows.length) { html += '<div style="color:var(--muted);font-size:12px">No records for selected filters.</div>'; }
    else {
      html += '<div style="overflow-x:auto"><table class="tbl"><thead><tr>' + sh.headers.map(h => '<th>' + h + '</th>').join('') + '</tr></thead><tbody>';
      sh.rows.slice(0, 8).forEach(row => { html += '<tr>' + row.map(c => '<td style="font-size:11px">' + (c == null ? '' : c) + '</td>').join('') + '</tr>'; });
      if (sh.rows.length > 8) html += '<tr><td colspan="' + sh.headers.length + '" style="text-align:center;color:var(--muted);font-size:11px">...and ' + (sh.rows.length - 8) + ' more rows in download</td></tr>';
      html += '</tbody></table></div>';
    }
    html += '</div>';
  });
  html += '</div>';
  area.innerHTML = html;
  area.scrollIntoView({ behavior: 'smooth' });
}

function quickProjReport(pid) {
  document.getElementById('rpt-project').value = pid;
  document.getElementById('rpt-type').value = 'full';
  document.getElementById('rpt-from').value = '';
  document.getElementById('rpt-to').value   = '';
  generateReport('pdf');
}

// ============================================================
// CRUD ‚Äî PROJECTS
// ============================================================
function saveProject() {
  const name = gv('np-name').trim();
  if (!name) { alert('Enter project name'); return; }
  const eid = gv('np-id');
  const existing = eid ? db.projects.find(p => p.id === eid) : null;
  const values = { estimated: gv('np-estimated') || null, quoted: gv('np-quoted') || null, awarded: gv('np-value') || null, revised: gv('np-revised') || null };
  const displayValue = +(values.revised || values.awarded || values.quoted || values.estimated) || 0;
  if (existing) {
    Object.assign(existing, { name, client: gv('np-client'), type: gv('np-type'), stage: gv('np-stage') || existing.stage, start: gv('np-start'), end: gv('np-end'), location: gv('np-location'), desc: gv('np-desc'), consultant: gv('np-consultant'), mc: gv('np-mc'), value: displayValue, values });
    if (!existing.checklists) existing.checklists = {};
    logActivity('Project updated: ' + name);
  } else {
    db.projects.push({ id: uid(), name, client: gv('np-client'), value: displayValue, values, type: gv('np-type'), start: gv('np-start'), end: gv('np-end'), location: gv('np-location'), desc: gv('np-desc'), consultant: gv('np-consultant'), mc: gv('np-mc'), stage: gv('np-stage') || 'Enquiry', checklists: {}, variations: [] });
    logActivity('Project created: ' + name);
  }
  saveDB(); closeModal('addProject');
  if (currentProject) openProjectDetail(currentProject); else navigate('projects');
}

function openNewProjectModal() {
  document.getElementById('addProjectTitle').textContent = 'NEW PROJECT';
  document.getElementById('saveProjectBtn').textContent  = 'Create Project';
  document.getElementById('np-id').value = '';
  ['np-name','np-client','np-start','np-end','np-location','np-desc','np-consultant','np-mc','np-estimated','np-quoted','np-value','np-revised'].forEach(id => { const e = document.getElementById(id); if (e) e.value = ''; });
  openModal('addProject');
}

function editProject(pid) {
  const p = db.projects.find(x => x.id === pid);
  if (!p) return;
  document.getElementById('addProjectTitle').textContent = 'EDIT PROJECT';
  document.getElementById('saveProjectBtn').textContent  = 'Save Changes';
  document.getElementById('np-id').value          = p.id;
  document.getElementById('np-name').value        = p.name || '';
  document.getElementById('np-client').value      = p.client || '';
  document.getElementById('np-type').value        = p.type || 'Curtain Wall';
  document.getElementById('np-stage').value       = p.stage || 'Enquiry';
  document.getElementById('np-start').value       = p.start || '';
  document.getElementById('np-end').value         = p.end || '';
  document.getElementById('np-location').value    = p.location || '';
  document.getElementById('np-desc').value        = p.desc || '';
  document.getElementById('np-consultant').value  = p.consultant || '';
  document.getElementById('np-mc').value          = p.mc || '';
  const v = p.values || {};
  document.getElementById('np-estimated').value   = v.estimated || p.value || '';
  document.getElementById('np-quoted').value      = v.quoted || '';
  document.getElementById('np-value').value       = v.awarded || '';
  document.getElementById('np-revised').value     = v.revised || '';
  document.getElementById('modal-addProject').classList.add('open');
}

function deleteProject(pid) {
  if (!confirm('Delete this project and ALL related data? This cannot be undone.')) return;
  db.projects   = db.projects.filter(p => p.id !== pid);
  db.tasks      = db.tasks.filter(t => t.projectId !== pid);
  db.materials  = db.materials.filter(m => m.projectId !== pid);
  db.issues     = db.issues.filter(i => i.projectId !== pid);
  db.tools      = db.tools.filter(t => t.projectId !== pid);
  db.labor      = db.labor.filter(l => l.projectId !== pid);
  db.finance    = db.finance.filter(f => f.projectId !== pid);
  db.documents  = db.documents.filter(d => d.projectId !== pid);
  db.logs       = db.logs.filter(l => l.projectId !== pid);
  db.revisions  = db.revisions.filter(r => r.projectId !== pid);
  db.certs      = db.certs.filter(c => c.projectId !== pid);
  db.mir        = db.mir.filter(m => m.projectId !== pid);
  saveDB(); showProjectList();
}

function addVariation() {
  const desc = gv('vo-desc').trim(); if (!desc) { alert('Enter description'); return; }
  const p = db.projects.find(x => x.id === currentProject); if (!p) return;
  if (!p.variations) p.variations = [];
  const isAdd = gv('vo-type').includes('Addition');
  const amount = +gv('vo-amount') || 0;
  p.variations.push({ id: uid(), desc, no: gv('vo-no'), type: isAdd ? 'Addition' : 'Deduction', amount, date: gv('vo-date'), status: gv('vo-status'), remarks: gv('vo-remarks') });
  const base = +(p.values && p.values.awarded ? p.values.awarded : p.value) || 0;
  const totalVar = p.variations.filter(v => v.status === 'Approved').reduce((s, v) => s + (v.type === 'Addition' ? +v.amount : -+v.amount), 0);
  if (!p.values) p.values = {};
  p.values.revised = base + totalVar || null;
  p.value = +(p.values.revised || p.values.awarded || p.values.quoted || p.values.estimated) || 0;
  logActivity('Variation: ' + desc); saveDB(); closeModal('addVariation'); openProjectDetail(currentProject);
}

// ============================================================
// CRUD ‚Äî TASKS
// ============================================================
function addTask() {
  const task = gv('at-task').trim(); if (!task) { alert('Enter task'); return; }
  const assignVal = gv('at-assign');
  const member = db.team.find(t => t.id === assignVal);
  const t = { id: uid(), task, projectId: gv('at-project'), assign: member ? member.name + ' (' + member.role + ')' : assignVal, assignId: assignVal, due: gv('at-due'), priority: gv('at-priority'), notes: gv('at-notes'), status: 'Pending' };
  db.tasks.push(t); logActivity('Task added: ' + task); saveDB(); closeModal('addTask');
  if (member && member.phone) sendWAForTask(t);
  if (currentProject) openProjectDetail(currentProject); else renderTasks();
}

function editTask(tid) {
  const t = db.tasks.find(x => x.id === tid); if (!t) return;
  populateAllSelects();
  document.getElementById('et-id').value       = t.id;
  document.getElementById('et-task').value     = t.task || '';
  document.getElementById('et-due').value      = t.due || '';
  document.getElementById('et-priority').value = t.priority || 'Medium';
  document.getElementById('et-status').value   = t.status || 'Pending';
  document.getElementById('et-notes').value    = t.notes || '';
  const sel = document.getElementById('et-assign');
  if (sel) {
    const defaults = ['Drawing Team','Estimation','Procurement','Finance','Admin','Site Supervisor','Me (Manager)'];
    let opts = db.team.length ? '<optgroup label="Your Team">' + db.team.map(tm => '<option value="' + tm.id + '">' + tm.name + ' (' + tm.role + ')</option>').join('') + '</optgroup><optgroup label="General">' : '';
    defaults.forEach(d => { opts += '<option value="' + d + '">' + d + '</option>'; });
    if (db.team.length) opts += '</optgroup>';
    sel.innerHTML = opts;
    sel.value = t.assignId || t.assign || '';
  }
  openModal('editTask');
}

function saveEditTask() {
  const t = db.tasks.find(x => x.id === gv('et-id')); if (!t) return;
  const av = gv('et-assign');
  const m  = db.team.find(x => x.id === av);
  t.task = gv('et-task'); t.assign = m ? m.name + ' (' + m.role + ')' : av; t.assignId = av;
  t.due = gv('et-due'); t.priority = gv('et-priority'); t.status = gv('et-status'); t.notes = gv('et-notes');
  logActivity('Task updated: ' + t.task); saveDB(); closeModal('editTask');
  if (currentProject) openProjectDetail(currentProject); else renderTasks();
}

function toggleTask(tid) {
  const t = db.tasks.find(x => x.id === tid);
  if (t) { t.status = t.status === 'Done' ? 'Pending' : 'Done'; saveDB(); }
  if (currentProject) openProjectDetail(currentProject); else renderTasks();
}
function deleteTask(id) { if (confirm('Delete task?')) { db.tasks = db.tasks.filter(t => t.id !== id); saveDB(); if (currentProject) openProjectDetail(currentProject); else renderTasks(); } }

// ============================================================
// CRUD ‚Äî MATERIALS
// ============================================================
function addMaterial() {
  const name = gv('am-name').trim(); if (!name) { alert('Enter material name'); return; }
  db.materials.push({ id: uid(), name, projectId: gv('am-project'), unit: gv('am-unit'), qty: +gv('am-qty') || 0, procured: +gv('am-procured') || 0, needBy: gv('am-needby'), supplier: gv('am-supplier'), rate: gv('am-rate') });
  logActivity('Material added: ' + name); saveDB(); closeModal('addMaterial');
  if (currentProject) openProjectDetail(currentProject); else renderMaterialsView();
}

function editMaterial(mid) {
  const m = db.materials.find(x => x.id === mid); if (!m) return;
  ['em-id|'+m.id,'em-name|'+m.name,'em-unit|'+(m.unit||'Nos'),'em-qty|'+(m.qty||0),'em-procured|'+(m.procured||0),'em-needby|'+(m.needBy||''),'em-supplier|'+(m.supplier||''),'em-rate|'+(m.rate||0),'em-remarks|'+(m.remarks||'')].forEach(kv => {
    const [k, v] = kv.split('|'); const e = document.getElementById(k); if (e) e.value = v;
  });
  openModal('editMaterial');
}
function saveEditMaterial() {
  const m = db.materials.find(x => x.id === gv('em-id')); if (!m) return;
  m.name = gv('em-name'); m.unit = gv('em-unit'); m.qty = +gv('em-qty') || 0; m.procured = +gv('em-procured') || 0;
  m.needBy = gv('em-needby'); m.supplier = gv('em-supplier'); m.rate = gv('em-rate'); m.remarks = gv('em-remarks');
  logActivity('Material updated: ' + m.name); saveDB(); closeModal('editMaterial');
  if (currentProject) openProjectDetail(currentProject); else renderMaterialsView();
}
function deleteMaterial(id) { if (confirm('Delete material and batches?')) { db.materials = db.materials.filter(m => m.id !== id); db.batches = db.batches.filter(b => b.materialId !== id); saveDB(); if (currentProject) openProjectDetail(currentProject); else renderMaterialsView(); } }
function quickUpdateMaterial(mid) { const m = db.materials.find(x => x.id === mid); if (!m) return; const p = prompt('Ordered qty (' + m.procured + '):', m.procured); if (p !== null) { m.procured = +p; saveDB(); if (currentProject) openProjectDetail(currentProject); else renderMaterialsView(); } }

// ============================================================
// CRUD ‚Äî ISSUES
// ============================================================
function editIssue(iid) {
  const i = db.issues.find(x => x.id === iid); if (!i) return;
  document.getElementById('ei-id').value       = i.id;
  document.getElementById('ei-title').value    = i.title || '';
  document.getElementById('ei-severity').value = i.severity || 'Medium';
  document.getElementById('ei-status').value   = i.status || 'Open';
  document.getElementById('ei-target').value   = i.target || '';
  document.getElementById('ei-desc').value     = i.desc || '';
  openModal('editIssue');
}
function saveEditIssue() {
  const i = db.issues.find(x => x.id === gv('ei-id')); if (!i) return;
  i.title = gv('ei-title'); i.severity = gv('ei-severity'); i.status = gv('ei-status'); i.target = gv('ei-target'); i.desc = gv('ei-desc');
  logActivity('Issue updated: ' + i.title); saveDB(); closeModal('editIssue');
  if (currentProject) openProjectDetail(currentProject); else renderIssuesView();
}
function resolveIssue(id) { const i = db.issues.find(x => x.id === id); if (i) { i.status = 'Resolved'; logActivity('Issue resolved: ' + i.title); saveDB(); } if (currentProject) openProjectDetail(currentProject); else renderIssuesView(); }
function deleteIssue(id) { if (confirm('Delete issue?')) { db.issues = db.issues.filter(i => i.id !== id); saveDB(); if (currentProject) openProjectDetail(currentProject); else renderIssuesView(); } }

// ============================================================
// CRUD ‚Äî TOOLS / LABOR / FINANCE
// ============================================================
function addTool() {
  const name = gv('tl-name').trim(); if (!name) { alert('Enter tool name'); return; }
  db.tools.push({ id: uid(), name, projectId: gv('tl-project'), qty: +gv('tl-qty') || 1, avail: +gv('tl-avail') || 0, needBy: gv('tl-needby'), source: gv('tl-source'), remarks: gv('tl-remarks') });
  logActivity('Tool added: ' + name); saveDB(); closeModal('addTool');
  if (currentProject) openProjectDetail(currentProject); else renderToolsView();
}
function deleteTool(id) { if (confirm('Delete?')) { db.tools = db.tools.filter(t => t.id !== id); saveDB(); if (currentProject) openProjectDetail(currentProject); else renderToolsView(); } }

function addLabor() {
  const trade = gv('lb-trade').trim(); if (!trade) { alert('Enter trade'); return; }
  db.labor.push({ id: uid(), trade, projectId: gv('lb-project'), req: +gv('lb-req') || 1, dep: +gv('lb-dep') || 0, mobDate: gv('lb-mobdate'), source: gv('lb-source'), remarks: gv('lb-remarks') });
  logActivity('Labor added: ' + trade); saveDB(); closeModal('addLabor');
  if (currentProject) openProjectDetail(currentProject); else renderLaborView();
}
function deleteLabor(id) { if (confirm('Delete?')) { db.labor = db.labor.filter(l => l.id !== id); saveDB(); if (currentProject) openProjectDetail(currentProject); else renderLaborView(); } }

function addFinance() {
  db.finance.push({ id: uid(), projectId: gv('fn-project'), type: gv('fn-type'), desc: gv('fn-desc'), amount: gv('fn-amount'), date: gv('fn-date'), status: gv('fn-status') });
  logActivity('Finance: ' + gv('fn-type') + ' Rs.' + gv('fn-amount')); saveDB(); closeModal('addFinance');
  if (currentProject) openProjectDetail(currentProject); else renderFinanceView();
}
function deleteFinance(id) { if (confirm('Delete?')) { db.finance = db.finance.filter(f => f.id !== id); saveDB(); if (currentProject) openProjectDetail(currentProject); else renderFinanceView(); } }

// ============================================================
// CRUD ‚Äî ASYNC FILE OPERATIONS
// ============================================================
async function addRevision() {
  const title = gv('rv-title').trim(); if (!title) { alert('Enter title'); return; }
  const btn = document.getElementById('btn-rv-save');
  if (btn) { btn.disabled = true; btn.textContent = 'Uploading...'; }
  const files = await uploadFilesFromInput('rv-file', btn);
  db.revisions.push({ id: uid(), projectId: currentProject, title, type: gv('rv-type'), rev: gv('rv-rev'), to: gv('rv-to'), by: gv('rv-by'), date: gv('rv-date'), status: gv('rv-status'), notes: gv('rv-notes'), files });
  logActivity('Revision: ' + title); saveDB();
  if (btn) { btn.disabled = false; btn.textContent = 'Save Revision'; }
  closeModal('addRevision'); openProjectDetail(currentProject);
  setTimeout(() => switchTabByName('ptab-revisions'), 100);
}

async function addBatch() {
  const mid = document.getElementById('modal-addBatch').dataset.mid;
  const m   = db.materials.find(x => x.id === mid); if (!m) return;
  const qty = +gv('bt-qty') || 0; if (qty <= 0) { alert('Enter valid quantity'); return; }
  const btn = document.getElementById('btn-bt-save');
  if (btn) { btn.disabled = true; btn.textContent = 'Uploading...'; }
  const files = await uploadFilesFromInput('bt-file', btn);
  db.batches.push({ id: uid(), materialId: mid, no: gv('bt-no'), qty, date: gv('bt-date'), vehicle: gv('bt-vehicle'), received: gv('bt-received'), condition: gv('bt-condition'), remarks: gv('bt-remarks'), files });
  logActivity('Batch: ' + qty + ' ' + m.unit + ' of ' + m.name); saveDB();
  if (btn) { btn.disabled = false; btn.textContent = 'Save Batch'; }
  closeModal('addBatch'); if (currentProject) openProjectDetail(currentProject); else renderMaterialsView();
}

async function addCert() {
  const name = gv('ct-name').trim(); if (!name) { alert('Enter certificate name'); return; }
  const btn = document.getElementById('btn-ct-save');
  if (btn) { btn.disabled = true; btn.textContent = 'Uploading...'; }
  const files = await uploadFilesFromInput('ct-file', btn);
  db.certs.push({ id: uid(), projectId: currentProject, name, material: gv('ct-material'), no: gv('ct-no'), issuer: gv('ct-issuer'), date: gv('ct-date'), valid: gv('ct-valid'), status: gv('ct-status'), notes: gv('ct-notes'), files });
  logActivity('Certificate: ' + name); saveDB();
  if (btn) { btn.disabled = false; btn.textContent = 'Save Certificate'; }
  closeModal('addCert'); openProjectDetail(currentProject); setTimeout(() => switchTabByName('ptab-delivery'), 100);
}

async function addMIR() {
  const title = gv('mir-title').trim(); if (!title) { alert('Enter title'); return; }
  const btn = document.getElementById('btn-mir-save');
  if (btn) { btn.disabled = true; btn.textContent = 'Uploading...'; }
  const files = await uploadFilesFromInput('mir-file', btn);
  db.mir.push({ id: uid(), projectId: currentProject, title, type: gv('mir-type'), no: gv('mir-no'), material: gv('mir-material'), date: gv('mir-date'), by: gv('mir-by'), clientRep: gv('mir-client-rep'), result: gv('mir-result'), sigStatus: gv('mir-sig'), notes: gv('mir-notes'), files });
  logActivity('MIR/WIR: ' + title); saveDB();
  if (btn) { btn.disabled = false; btn.textContent = 'Save Report'; }
  closeModal('addMIR'); openProjectDetail(currentProject); setTimeout(() => switchTabByName('ptab-mir'), 100);
}

async function addIssue() {
  const title = gv('is-title').trim(); if (!title) { alert('Enter issue title'); return; }
  const btn = document.getElementById('btn-is-save');
  if (btn) { btn.disabled = true; btn.textContent = 'Uploading...'; }
  const files = await uploadFilesFromInput('is-file', btn);
  const av = gv('is-assign'); const mem = db.team.find(t => t.id === av);
  db.issues.push({ id: uid(), title, projectId: gv('is-project'), severity: gv('is-severity'), cat: gv('is-cat'), by: gv('is-by'), date: gv('is-date'), assign: mem ? mem.name + ' (' + mem.role + ')' : av, assignId: av, target: gv('is-target'), desc: gv('is-desc'), status: 'Open', files });
  logActivity('Issue: ' + title); saveDB();
  if (btn) { btn.disabled = false; btn.textContent = 'Raise Issue'; }
  closeModal('addIssue'); if (currentProject) openProjectDetail(currentProject); else renderIssuesView();
}

async function addDocument() {
  const name = gv('dc-name').trim(); if (!name) { alert('Enter document name'); return; }
  const btn = document.getElementById('btn-dc-save');
  if (btn) { btn.disabled = true; btn.textContent = 'Uploading...'; }
  const files = await uploadFilesFromInput('dc-file', btn);
  db.documents.push({ id: uid(), name, projectId: gv('dc-project'), type: gv('dc-type'), by: gv('dc-by'), date: gv('dc-date'), status: gv('dc-status'), notes: gv('dc-notes'), files });
  logActivity('Document: ' + name); saveDB();
  if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
  closeModal('addDocument'); if (currentProject) openProjectDetail(currentProject); else renderDocumentsView();
}

async function addLog() {
  const p = db.projects.find(pr => pr.id === currentProject); if (!p) return;
  const btn = document.getElementById('btn-lg-save');
  if (btn) { btn.disabled = true; btn.textContent = 'Uploading...'; }
  const files = await uploadFilesFromInput('lg-file', btn);
  db.logs.push({ id: uid(), projectId: currentProject, date: gv('lg-date'), weather: gv('lg-weather'), workers: gv('lg-workers'), prog: gv('lg-prog'), work: gv('lg-work'), issues: gv('lg-issues'), instructions: gv('lg-instructions'), files });
  logActivity('Daily log: ' + p.name); saveDB();
  if (btn) { btn.disabled = false; btn.textContent = 'Save Log'; }
  closeModal('addLog'); openProjectDetail(currentProject); setTimeout(() => switchTabByName('ptab-log'), 100);
}

// ============================================================
// CRUD ‚Äî DOCUMENTS
// ============================================================
function addTeamMember() {
  const name  = document.getElementById('tm-name').value.trim();
  const phone = document.getElementById('tm-phone').value.trim().replace(/\D/g, '');
  const role  = gv('tm-role');
  if (!name)  { alert('Enter name'); return; }
  if (!phone) { alert('Enter WhatsApp number'); return; }
  db.team.push({ id: uid(), name, phone, role });
  logActivity('Team member added: ' + name); saveDB();
  document.getElementById('tm-name').value = '';
  document.getElementById('tm-phone').value = '';
  renderTeamView();
}
function deleteTeamMember(id) { if (confirm('Remove?')) { db.team = db.team.filter(t => t.id !== id); saveDB(); renderTeamView(); } }
function markMIRSigned(id) { const m = db.mir.find(x => x.id === id); if (m) { m.sigStatus = 'Signed ‚Äì Approved'; logActivity('MIR signed: ' + m.title); saveDB(); } openProjectDetail(currentProject); }
function advanceStage(pid) { const p = db.projects.find(pr => pr.id === pid); const i = PROJECT_STAGES.indexOf(p.stage); if (i < PROJECT_STAGES.length - 1) { p.stage = PROJECT_STAGES[i + 1]; logActivity(p.name + ' advanced to ' + p.stage); saveDB(); openProjectDetail(pid); } }
function regressStage(pid) { const p = db.projects.find(pr => pr.id === pid); const i = PROJECT_STAGES.indexOf(p.stage); if (i > 0) { p.stage = PROJECT_STAGES[i - 1]; saveDB(); openProjectDetail(pid); } }

// ============================================================
// WHATSAPP
// ============================================================
function buildWAMessage(name, task, priority, due, project, notes) {
  const pMap = { High: '[HIGH PRIORITY]', Medium: '[MEDIUM PRIORITY]', Low: '[LOW PRIORITY]' };
  return 'Hello ' + name + ',\n\nA task has been assigned to you.\n\nTASK: ' + task + '\nPRIORITY: ' + (pMap[priority] || priority) + '\nDUE DATE: ' + (due ? fmtDate(due) : 'Not set') + '\nPROJECT: ' + (project || 'General') + (notes ? '\nNOTES: ' + notes : '') + '\n\nPlease confirm and proceed.\n\n- FacadeOps Project Management';
}
function updateWAPreview() {
  const av  = gv('at-assign');
  const mem = db.team.find(t => t.id === av);
  const box = document.getElementById('wa-preview-box');
  const btn = document.getElementById('addTaskBtn');
  if (mem && mem.phone) {
    const proj = db.projects.find(p => p.id === gv('at-project'));
    document.getElementById('wa-preview-text').textContent = buildWAMessage(mem.name, gv('at-task') || '(task)', gv('at-priority'), gv('at-due'), proj ? proj.name : '', gv('at-notes'));
    box.style.display = 'block';
    btn.textContent = 'Save Task + Send WhatsApp';
    btn.style.background = 'var(--wa)';
    btn.style.color = '#fff';
  } else {
    box.style.display = 'none';
    btn.textContent = 'Save Task';
    btn.style.background = '';
    btn.style.color = '';
  }
}
function sendWAForTask(task) {
  const m = db.team.find(t => t.id === task.assignId);
  if (!m || !m.phone) return;
  const proj = db.projects.find(p => p.id === task.projectId);
  const msg  = buildWAMessage(m.name, task.task, task.priority, task.due, proj ? proj.name : '', task.notes);
  setTimeout(() => { window.open('https://wa.me/' + m.phone + '?text=' + encodeURIComponent(msg), '_blank'); }, 400);
}
function sendWATest(tid) {
  const t = db.team.find(x => x.id === tid); if (!t) return;
  window.open('https://wa.me/' + t.phone + '?text=' + encodeURIComponent('Hello ' + t.name + '! Test message from FacadeOps.'), '_blank');
}

// ============================================================
// MODALS & TABS
// ============================================================
function openModal(name) {
  populateAllSelects();
  document.getElementById('modal-' + name).classList.add('open');
  if (name === 'addTask') setTimeout(updateWAPreview, 50);
}
function closeModal(name) { document.getElementById('modal-' + name).classList.remove('open'); }

function openModalForProject(modalName, pid) {
  openModal(modalName);
  const map = { addTask:'at-project', addMaterial:'am-project', addTool:'tl-project', addLabor:'lb-project', addFinance:'fn-project', addDocument:'dc-project', addIssue:'is-project' };
  setTimeout(() => {
    const sel = document.getElementById(map[modalName]);
    if (sel) sel.value = pid;
    if (modalName === 'addTask') updateWAPreview();
  }, 60);
}

function openRevisionModal(pid) { currentProject = pid; openModal('addRevision'); document.getElementById('rv-date').value = new Date().toISOString().split('T')[0]; }
function openBatchModal(mid) {
  const m = db.materials.find(x => x.id === mid); if (!m) return;
  const del = db.batches.filter(b => b.materialId === mid).reduce((s, b) => s + Number(b.qty), 0);
  document.getElementById('modal-addBatch').dataset.mid = mid;
  document.getElementById('batch-material-info').innerHTML = '<b>' + m.name + '</b><br>Required: ' + m.qty + ' ' + m.unit + ' | Ordered: ' + m.procured + ' ' + m.unit + ' | Delivered: ' + del + ' ' + m.unit + ' | Remaining: ' + (m.qty - del) + ' ' + m.unit;
  document.getElementById('bt-date').value = new Date().toISOString().split('T')[0];
  openModal('addBatch');
}
function openCertModal(pid)  { currentProject = pid; openModal('addCert');  document.getElementById('ct-date').value  = new Date().toISOString().split('T')[0]; }
function openMIRModal(pid)   { currentProject = pid; populateAllSelects(); openModal('addMIR'); document.getElementById('mir-date').value = new Date().toISOString().split('T')[0]; }
function openLogModal(pid)   { currentProject = pid; openModal('addLog');   document.getElementById('lg-date').value  = new Date().toISOString().split('T')[0]; }
function openVariationModal(pid) { currentProject = pid; document.getElementById('vo-date').value = new Date().toISOString().split('T')[0]; openModal('addVariation'); }

function populateAllSelects() {
  ['at-project','am-project','tl-project','lb-project','fn-project','dc-project','is-project'].forEach(sid => {
    const sel = document.getElementById(sid); if (!sel) return;
    sel.innerHTML = db.projects.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('') || '<option value="">No projects</option>';
  });
  ['at-assign','is-assign'].forEach(sid => {
    const sel = document.getElementById(sid); if (!sel) return;
    const defs = ['Drawing Team','Estimation','Procurement','Finance','Admin','Site Supervisor','Me (Manager)'];
    let opts = db.team.length ? '<optgroup label="Your Team">' + db.team.map(t => '<option value="' + t.id + '">' + t.name + ' (' + t.role + ')</option>').join('') + '</optgroup><optgroup label="General">' : '';
    defs.forEach(d => { opts += '<option value="' + d + '">' + d + '</option>'; });
    if (db.team.length) opts += '</optgroup>';
    sel.innerHTML = opts;
  });
}

document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('open'); });
});

function switchTab(el, tabId) {
  el.closest('.tabs').querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.project-tab').forEach(t => t.style.display = 'none');
  document.getElementById(tabId).style.display = 'block';
}
function switchTabByName(tabId) {
  document.querySelectorAll('.project-tab').forEach(t => t.style.display = 'none');
  const el = document.getElementById(tabId); if (el) el.style.display = 'block';
  document.querySelectorAll('#projectTabs .tab').forEach(t => {
    const oc = t.getAttribute('onclick') || '';
    t.classList.toggle('active', oc.includes("'" + tabId + "'"));
  });
}

// Close sidebar on mobile nav click
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
      if (window.innerWidth <= 768) document.getElementById('sidebar-nav').classList.remove('open');
    });
  });
});

// ============================================================
// INIT
// ============================================================
loadLocal();
</script>
</body>
</html>
